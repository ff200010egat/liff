<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: system-ui; padding:16px; }
button { width:100%; padding:16px; margin-bottom:10px; }
.primary{background:#0a7cff;color:#fff}
.secondary{background:#e0e0e0}
.danger{background:#e53935;color:#fff}
input,select{width:100%;padding:12px;margin-bottom:8px}
#formBox,#historyBox{display:none}
</style>
</head>
<body>

<h2>ระบบจองรถ</h2>
<div id="username"></div>
<div id="role"></div>

<button id="mainBtn" class="primary"></button>
<button id="subBtn" class="secondary"></button>
<div id="driverBox"></div>

<div id="formBox">
  <h3>ฟอร์มจอง</h3>
  <input type="date" id="booking_date">
  <input type="time" id="booking_time">
  <input type="text" id="pickup_location" placeholder="จุดรับ">
  <input type="text" id="dropoff_location" placeholder="จุดส่ง">
  <input type="text" id="contact_mobile" placeholder="เบอร์ติดต่อ">
  <button onclick="submitBooking()" class="primary">บันทึก</button>
</div>

<div id="historyBox"></div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwdQH6tF0IV5KCrmOrA2bKe9kJKJkqHR1upjVR9q_ixgvgI7zxeTFVVlGBS9p9BH2sRgA/exec";
let userId="", role="", mobile="";

async function init(){
  await liff.init({liffId:"2008934745-qU0fPztf"});
  if(!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  userId = p.userId;
  username.innerText = p.displayName;

  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:p.displayName
    })
  }).then(r=>r.json());

  role = r.role;
  mobile = r.mobile||"";
  render();
}

function render(){
  role === "driver"
    ? mainBtn.innerText="กรอกงานเอง"
    : mainBtn.innerText="จองรถ";

  mainBtn.onclick = ()=>{
    formBox.style.display="block";
    contact_mobile.value = mobile;
  };

  subBtn.innerText="ประวัติ";
  subBtn.onclick = ()=>alert("ดึงจาก sheet ต่อได้");

  if(role==="user"){
    driverBox.innerHTML=`
      <button class="secondary" onclick="registerDriver()">ลงทะเบียนเป็นพนักงานขับรถ</button>`;
  }
}

async function registerDriver(){
  const m = prompt("เบอร์โทร:");
  if(!m) return;
  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:m
    })
  }).then(r=>r.json());

  if(r.success){ alert("สำเร็จ"); location.reload(); }
  else alert("เบอร์ไม่ถูกต้อง");
}

async function submitBooking(){
  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action: role==="driver"?"driver_create_booking":"create_booking",
      line_user_id:userId,
      driver_name: username.innerText,
      booking_date:booking_date.value,
      booking_time:booking_time.value,
      pickup_location:pickup_location.value,
      dropoff_location:dropoff_location.value,
      contact_mobile:contact_mobile.value
    })
  }).then(r=>r.json());

  if(r.success){ alert("บันทึกแล้ว"); location.reload(); }
}

init();
</script>
</body>
</html>
