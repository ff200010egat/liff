<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#fafafa;
  padding:16px;
}

h2 { font-size:26px; margin-bottom:6px; }
#username { font-size:20px; }
#role { font-size:18px; color:#555; margin-bottom:16px; }

button {
  width:100%;
  padding:18px;
  font-size:20px;
  border:none;
  border-radius:14px;
  margin-bottom:12px;
}

.big { font-size:24px; padding:26px; background:#0a7cff; color:#fff; }
.secondary { background:#e0e0e0; }
.danger { background:#e53935; color:#fff; }

.card {
  background:#fff;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 1px 4px rgba(0,0,0,.1);
}

.hidden { display:none; }
</style>
</head>

<body>

<!-- HOME -->
<div id="home">
  <h2>ระบบจองรถ หก-มน.</h2>
  <div id="username"></div>
  <div id="role"></div>

  <button class="big" onclick="openBooking()">จองรถพร้อมคนขับ</button>
  <button class="secondary" onclick="openHistory()">ดูประวัติการจอง</button>
  <div id="driverBox"></div>
</div>

<!-- HISTORY -->
<div id="history" class="hidden">
  <h2>ประวัติการจอง</h2>
  <div id="historyList"></div>
  <button class="secondary" onclick="backHome()">กลับ</button>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzhO1TQ7bvAf-0tIO75pHuYlNg4eIWeU9jTlDz4H-AJBHTSvC4mXH7diVrFrbnXAZ3StQ/exec";
let userId="", role="", mobile="";

async function init() {
  await liff.init({ liffId:"2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  const p = await liff.getProfile();
  userId = p.userId;
  username.innerText = p.displayName;

  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:p.displayName
    })
  }).then(r=>r.json());

  role = r.role;
  mobile = r.mobile || "";

  role === "driver"
    ? roleLabel("พนักงานขับรถ")
    : roleLabel("ผู้ใช้งานทั่วไป");
}

function roleLabel(text){
  role.innerText = "บทบาท: " + text;
}

function openBooking(){ alert("ใช้ฟอร์มจองเดิม"); }

async function openHistory() {
  home.classList.add("hidden");
  history.classList.remove("hidden");
  historyList.innerHTML = "กำลังโหลด...";

  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"get_my_bookings",
      line_user_id:userId
    })
  }).then(r=>r.json());

  historyList.innerHTML = "";

  if (!r.bookings.length) {
    historyList.innerHTML = "<p>ยังไม่มีประวัติการจอง</p>";
    return;
  }

  r.bookings.forEach(b=>{
    historyList.innerHTML += `
      <div class="card">
        <strong>${b.date} ${b.time}</strong><br>
        รถ: ${b.vehicle}<br>
        ${b.pickup} → ${b.dropoff}<br>
        สถานะ: ${b.status}
      </div>
    `;
  });
}

function backHome(){
  history.classList.add("hidden");
  home.classList.remove("hidden");
}

init();
</script>
</body>
</html>
