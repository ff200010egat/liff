<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CAR bookings MMSC</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding:16px; background:#f0f2f5; color:#333; margin:0;
  position: relative; }
  .card { background:#fff; padding:16px; border-radius:12px; margin-bottom:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border:1px solid #eee;
  }
  .card.past-job { opacity: 0.6; background: #f8f9fa; filter: grayscale(0.5); }
  h2 { font-size:22px; color:#0a7cff; margin-bottom:5px;
  }
    
  .profile-container { display: flex; align-items: center; gap: 12px; margin-bottom: 5px;
  }
  #profileImg { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  object-fit: cover; display: none; }
    
  #username { font-weight:bold; font-size:18px; }
  #roleBadge { display:inline-block;
  padding:3px 10px; border-radius:15px; background:#e4e6eb; font-size:12px; margin-bottom:15px; font-weight:600; }
    
  button { width:100%; padding:14px; font-size:16px; border-radius:10px; border:none;
  margin-bottom:8px; cursor: pointer; font-weight:bold; }
  .primary { background:#0a7cff; color:#fff; }
  .secondary { background:#e4e6eb; color:#4b4f56;
  }
  .success { background:#28a745; color:#fff; }
  .warning { background:#f39c12; color:#fff; }
  .danger { background:#fff1f0; color:#ff4d4f;
  border:1px solid #ffccc7; padding:10px; font-size:14px; }
    
  label { display: block; font-weight: bold; margin-bottom: 5px;
  font-size: 14px; color: #555; }
  input, select { width:100%; padding:12px; box-sizing: border-box; font-size:16px; margin-bottom:12px; border-radius:8px; border:1px solid #ddd;
  background: #fff; }
    
  #formBox { display:none; }
  .val-text { font-size:15px; margin-bottom:5px; line-height: 1.4;
  }

  .admin-tools { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; align-items: center;
  }
  .admin-btn { font-size: 18px; cursor: pointer; background: #fff; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center;
  justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-decoration: none; color: inherit; }
  .admin-lock { font-size: 20px; cursor: pointer;
  background: #fff; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; justify-content:center; align-items:center; flex-direction:column;
  }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0a7cff; border-radius: 50%; width: 45px; height: 45px;
  animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);
  } }

  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
  .modal-box { background:#fff;
  padding:20px; border-radius:12px; width:85%; max-width:320px; text-align:center; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  /* [ADDED] Styles for Series Card */
  .series-card { border-left: 5px solid #0a7cff; background: #f0f7ff; }
  .series-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:12px; font-weight:bold; color:#0a7cff;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<div class="admin-tools">
  <a id="calBtn" href="https://calendar.google.com/calendar/embed?src=a2268447d45f4d8def8af5a731281f1bd9d2d0cd9a285720611db2a8f35e54db%40group.calendar.google.com&ctz=Asia%2FBangkok&hl=th" target="_blank" class="admin-btn" style="display:none;">üìÖ</a>
  <a id="dashBtn" href="https://lookerstudio.google.com/reporting/03ec1f8d-6821-4e4f-bb73-9732dca2f7b8?openExternalBrowser=1" target="_blank" class="admin-btn" style="display:none;">üìä</a>
  <div id="adminLockBtn" class="admin-lock" onclick="becomeAdmin()">üîë</div>
</div>

<div style="max-width: 500px; margin: auto;">
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
    
  <div class="profile-container">
    <img id="profileImg" src="" alt="Profile Image">
    <div id="username">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</div>
  </div>
    
  <div id="roleBadge">...</div>
  <div id="driverMobileArea" style="font-size: 14px;
  color: #666; margin-top: -10px; margin-bottom: 15px; font-weight: bold;"></div>

  <div id="actionArea">
    <button id="bookBtn" class="primary">...</button>
    <div id="roleToggleArea"></div> 
  </div>

  <div id="formBox" class="card">
    <h3 style="margin-top:0;
    color:#0a7cff;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>

    <div style="margin-bottom:12px;">
      <button type="button" id="modeToggle" class="secondary" style="background:#e3f2fd; color:#0a7cff; border:1px solid #0a7cff;" onclick="toggleBookingMode()">üîÑ ‡πÇ‡∏´‡∏°‡∏î: ‡∏à‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</button>
    </div>

    <div id="adminAssignArea" style="display:none;">
      <label>üèé ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (Admin Only)</label>
      <select id="assign_driver_id">
        <option value="">-- ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á --</option>
      </select>
    </div>
      
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á <span id="modeLabel" style="font-weight:normal; color:#666; font-size:12px;">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏ß‡∏±‡∏ô)</span></label>
    <input type="text" id="booking_date" placeholder="‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..." readonly="readonly" style="background-color: #fff;">
    <div id="selectedDatesList" style="margin-bottom:10px; font-size:14px; color:#666; font-style:italic;"></div>
      
    <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
    <input type="time" id="booking_time">
      
    <label>üöó ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
    <select id="vehicle_type">
      <option 
      value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>
      
    <label>üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
    <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
    <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á)">
    <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)">
    <input type="text" id="remark" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô">
      
    <label>‚è± ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
    <select id="duration">
      <option value="1">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="1.5">1.30 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="2">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="2.5">2.30 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="3">3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="4">4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="5">5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="6">6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="7">7 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="8">8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
    </select>

    <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
      
    <button class="primary" onclick="submitBooking()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="historyBox"></div>
</div>

<div id="assignModal" class="modal-overlay">
  
<div class="modal-box">
    <h3 style="color:#0a7cff; margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>
    <p style="font-size:14px; color:#666;
    margin-bottom:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>
    <select id="modal_driver_select" style="margin-bottom:20px;"></select>
    <div style="display:flex;
    gap:10px;">
      <button class="primary" onclick="confirmAssign()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button class="secondary" onclick="closeAssignModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwC51rAEy9XS7TeGfcGLY38U036JVuNrwSMKQkGLrNipBqtiCt9MPl3pPecZOxJav9WIw/exec";
let userId = "", role = "", mobile = "", displayName = "";
let driverListCache = [];
let currentBookingIdToAssign = null;
// [ADDED] Global variables for Series feature
let isSeriesMode = false;
let fpInstance = null;

function toggleLoad(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }

function formatThaiDateTime(dateVal, timeVal) {
  if (!dateVal) return "-";
  const d = new Date(dateVal);
  const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
  const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
  let timeStr = String(timeVal).includes("T") ? new 
  Date(timeVal).getHours().toString().padStart(2,'0')+":"+new Date(timeVal).getMinutes().toString().padStart(2,'0') : String(timeVal).substring(0,5);
  return dateStr + " | " + timeStr + " ‡∏ô.";
}

// [ADDED] Shared GAS fetch helper ‚Äî handles GAS 302 redirect + text‚ÜíJSON parse
function gasFetch(payload) {
  return fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(function(r) { return r.text(); }).then(function(t) { return JSON.parse(t); });
}

async function init() {
  toggleLoad(true);
  try {
    await liff.init({ liffId: "2008934745-qU0fPztf" });
    if (!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userId = p.userId; displayName = p.displayName;
      
    document.getElementById("username").innerText = displayName;
    if (p.pictureUrl) {
      const pImg = document.getElementById("profileImg");
      pImg.src = p.pictureUrl;
      pImg.style.display = "block";
    }

    const res = await gasFetch({ action: "auto_register", line_user_id: userId, display_name: displayName });
    role = res.role;
    mobile = res.mobile; 
    renderUI();
    // [ADDED] Init Flatpickr
    initFlatpickr();
    await showHistory();
  } catch (err) { alert(err); toggleLoad(false);
  }
}

// [ADDED] Flatpickr Initialization and Toggle
function initFlatpickr() {
  const cfg = {
    dateFormat: "Y-m-d",
    minDate: "today",
    disableMobile: "true",
    onChange: function(selectedDates, dateStr, instance) {
       if(isSeriesMode) {
          document.getElementById("selectedDatesList").innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedDates.length} ‡∏ß‡∏±‡∏ô: ` + selectedDates.map(d => d.getDate()+"/"+(d.getMonth()+1)).join(", ");
       } else {
          document.getElementById("selectedDatesList").innerText = "";
       }
    }
  };
  fpInstance = flatpickr("#booking_date", cfg);
}

function toggleBookingMode() {
  isSeriesMode = !isSeriesMode;
  const btn = document.getElementById("modeToggle");
  const label = document.getElementById("modeLabel");
  
  if (isSeriesMode) {
     btn.innerHTML = "üîÑ ‡πÇ‡∏´‡∏°‡∏î: <b>‡∏à‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (Series)</b>";
     btn.style.background = "#fff3cd"; // Yellowish
     btn.style.color = "#856404";
     btn.style.borderColor = "#ffeeba";
     label.innerText = "(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)";
     // Re-init Flatpickr as multiple
     fpInstance.destroy();
     fpInstance = flatpickr("#booking_date", { mode: "multiple", dateFormat: "Y-m-d", minDate: "today", disableMobile: "true",
        onChange: function(selectedDates) {
          document.getElementById("selectedDatesList").innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedDates.length} ‡∏ß‡∏±‡∏ô: ` + selectedDates.map(d => d.getDate()+"/"+(d.getMonth()+1)).join(", ");
        }
     });
  } else {
     btn.innerHTML = "üîÑ ‡πÇ‡∏´‡∏°‡∏î: <b>‡∏à‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</b>";
     btn.style.background = "#e3f2fd"; // Blueish
     btn.style.color = "#0a7cff";
     btn.style.borderColor = "#0a7cff";
     label.innerText = "(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏ß‡∏±‡∏ô)";
     document.getElementById("selectedDatesList").innerText = "";
     // Re-init Flatpickr as single
     fpInstance.destroy();
     fpInstance = flatpickr("#booking_date", { mode: "single", dateFormat: "Y-m-d", minDate: "today", disableMobile: "true" });
  }
}

function renderUI() {
  const bookBtn = document.getElementById("bookBtn");
  const roleToggleArea = document.getElementById("roleToggleArea");
  const mobileArea = document.getElementById("driverMobileArea");
  const adminArea = document.getElementById("adminAssignArea");
  const adminLockBtn = document.getElementById("adminLockBtn");
  const calBtn = document.getElementById("calBtn");
  const dashBtn = document.getElementById("dashBtn");
  if (role === "admin") {
    document.getElementById("roleBadge").innerText = "üõ°Ô∏è ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)";
    bookBtn.innerText = "‚ûï ‡∏•‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô‡∏ô‡∏≤‡∏° Admin)";
    adminArea.style.display = "block";
    loadDriversList();
      
    calBtn.style.display = "flex";
    dashBtn.style.display = "flex";
      
    adminLockBtn.innerText = "üîì";
    adminLockBtn.onclick = cancelAdminRole;
  } else if (role === "driver") {
    document.getElementById("roleBadge").innerText = "üîì ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ";
    bookBtn.innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á)";
    adminArea.style.display = "none";
      
    calBtn.style.display = "none";
    dashBtn.style.display = "none";
    adminLockBtn.innerText = "üîë";
    adminLockBtn.onclick = becomeAdmin;
  } else {
    document.getElementById("roleBadge").innerText = "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
    bookBtn.innerText = "üìÖ ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤";
    adminArea.style.display = "none";
      
    calBtn.style.display = "none";
    dashBtn.style.display = "none";
    adminLockBtn.innerText = "üîë";
    adminLockBtn.onclick = becomeAdmin;
  }

  mobileArea.innerText = (role === "driver" && mobile) ?
  "üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: " + mobile : "";
  bookBtn.onclick = () => { document.getElementById("formBox").style.display = "block"; window.scrollTo(0,0); };
  let toggleHtml = "";
  if (role === "admin") {
    toggleHtml = `<button class="secondary" style="background:#fff1f0; color:#ff4d4f;" onclick="cancelAdminRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Admin</button>`;
  } else if (role === "driver") {
    toggleHtml = `<button class="secondary" onclick="editDriverMobile()">üìû ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
                  <button class="secondary" style="background:#fff1f0; color:#ff4d4f;"
  onclick="cancelDriverRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  } else {
    toggleHtml = `<button class="secondary" onclick="registerDriver()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  }
  roleToggleArea.innerHTML = toggleHtml;
}

async function loadDriversList() {
  const res = await gasFetch({ action: "get_drivers_list" });
  if (res.success) {
    driverListCache = res.drivers;
    const select = document.getElementById("assign_driver_id");
    select.innerHTML = '<option value="">-- ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á --</option>';
    res.drivers.forEach(d => {
      select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
    });
  }
}

// [MODIFIED] Update showHistory to support Grouping
async function showHistory() {
  toggleLoad(true);
  const hBox = document.getElementById("historyBox");
  const res = await gasFetch({ action: "get_all_bookings", line_user_id: userId });
  const nowDay = new Date().setHours(0,0,0,0);
  let filtered = (res.data || []).filter(b => {
    if (role === "admin") return true;
    if (role === "driver") return (b.booked_by === userId || b.driver_line_id === userId || b.status === "pending");
    return (b.booked_by === userId);
  });
  // ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 3 ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà):
  // 1. upcomingList = ‡∏á‡∏≤‡∏ô Active (‡πÑ‡∏°‡πà Cancel) ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô >= ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  // 2. pastList = ‡∏á‡∏≤‡∏ô Active (‡πÑ‡∏°‡πà Cancel) ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô < ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞ Status != pending
  // 3. failedList = ‡∏á‡∏≤‡∏ô Active ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô < ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞ Status == pending (‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
  // 4. cancelledList = ‡∏á‡∏≤‡∏ô Cancel
   
  let allNonCancelled = filtered.filter(b => b.status !== "cancelled");
  let cancelledList = filtered.filter(b => b.status === "cancelled");

  let upcomingList = allNonCancelled.filter(b => new Date(b.booking_date).setHours(0,0,0,0) >= nowDay);
  // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏¢‡∏Å pending ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà failedList ***
  let pastList = allNonCancelled.filter(b => new Date(b.booking_date).setHours(0,0,0,0) < nowDay && b.status !== 'pending');
  let failedList = allNonCancelled.filter(b => new Date(b.booking_date).setHours(0,0,0,0) < nowDay && b.status === 'pending');
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏à‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÑ‡∏õ‡πÑ‡∏Å‡∏•) ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
  const sortFunc = (a, b) => new Date(a.booking_date) - new Date(b.booking_date) ||
  (a.booking_time > b.booking_time ? 1 : -1);
   
  upcomingList.sort(sortFunc);
  pastList.sort(sortFunc);
  failedList.sort(sortFunc);
  cancelledList.sort(sortFunc);

  // [ADDED] Render Logic with Grouping
  const renderList = (list) => {
    // Grouping by batch_id
    let grouped = {};
    let singles = [];
    
    list.forEach(b => {
      if(b.batch_id) {
        if(!grouped[b.batch_id]) grouped[b.batch_id] = [];
        grouped[b.batch_id].push(b);
      } else {
        singles.push(b);
      }
    });

    let mixedList = [...singles];
    Object.keys(grouped).forEach(k => {
      mixedList.push({ isSeries: true, items: grouped[k], sortDate: grouped[k][0].booking_date, batch_id: k });
    });
    
    // Sort mixed list by date
    mixedList.sort((a, b) => {
      let dA = a.isSeries ? new Date(a.sortDate) : new Date(a.booking_date);
      let dB = b.isSeries ? new Date(b.sortDate) : new Date(b.booking_date);
      return dA - dB;
    });

    if (mixedList.length === 0) return "";
    return mixedList.map(item => item.isSeries ? renderSeriesCard(item) : renderCard(item)).join("");
  };

  // 1. ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
  let html = "<h3 style='margin: 20px 0 10px 0;'>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ)</h3>";
  if(upcomingList.length === 0) html += "<p style='color:#777;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</p>";
  else html += renderList(upcomingList);
  // 1.5 ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (New)
  if(failedList.length > 0) {
    html += `
      <div style="margin-top:25px; border-top: 1px dashed #ccc; padding-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#d9534f;">‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)</h3>
            <button class="secondary" style="width:auto; padding:8px 15px; font-size:14px; margin:0;"
            onclick="toggleFailed()">
                ‚ö†Ô∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (${failedList.length})
            </button>
        </div>
        <div id="failedArea" style="display:none; margin-top:15px;">
           ${renderList(failedList)}
        </div>
      </div>
    `;
  }

  // 2. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Toggle)
  if(pastList.length > 0) {
    html += `
      <div style="margin-top:25px; border-top: 1px dashed #ccc; padding-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#666;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
            <button class="secondary" style="width:auto; padding:8px 15px; font-size:14px; margin:0;"
            onclick="togglePast()">
                üìú ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (${pastList.length})
            </button>
        </div>
        <div id="pastArea" style="display:none; margin-top:15px;">
           ${renderList(pastList)}
        </div>
      </div>
    `;
  }

  // 3. ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å (Toggle)
  if(cancelledList.length > 0) {
    html += `
      <div style="margin-top:25px; border-top: 1px dashed #ccc; padding-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#666;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h3>
            <button class="secondary" style="width:auto; padding:8px 15px; font-size:14px; margin:0;"
            onclick="toggleCancelled()">
                üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (${cancelledList.length})
            </button>
        </div>
        <div id="cancelledArea" style="display:none; margin-top:15px;">
           ${renderList(cancelledList)}
        </div>
      </div>
    `;
  }

  hBox.innerHTML = html;
  toggleLoad(false);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Render Card (Single)
const renderCard = (b) => {
    const nowDay = new Date().setHours(0,0,0,0);
    const isPast = new Date(b.booking_date).setHours(0,0,0,0) < nowDay;
    const isCancelled = b.status === "cancelled";
    let statusColor = (b.status === "pending") ? "#f39c12" : (isCancelled ? "#d9534f" : "#28a745");
    let ackBtn = "";
    if (role === "driver" && b.driver_line_id === userId && b.status === "confirmed") {
        ackBtn = `<button class="warning" onclick="acknowledgeJob('${b.booking_id}')">üëå ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</button>`;
    }

    let adminAssignBtn = "";
    if (role === "admin" && !isCancelled) {
        adminAssignBtn = `<button class="primary" style="background:#17a2b8; margin-bottom:8px;"
        onclick="openAssignModal('${b.booking_id}')">üë§ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Admin)</button>`;
    }

    return `
      <div class="card ${ (isPast || isCancelled) ? 'past-job' : '' }">
        <div class="val-text"><b>${b.pickup_location} ‚û°Ô∏è ${b.dropoff_location}</b></div>
        <div class="val-text">üìÖ ${formatThaiDateTime(b.booking_date, b.booking_time)}</div>
        <div class="val-text">üë§ ‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢: ${b.user_display_name} |
        üöó ${b.vehicle_type}</div>
        <div class="val-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="font-weight:bold; color:${statusColor}">${b.status.toUpperCase()} ${b.driver_name ?
        '('+b.driver_name+')' : ''}</span></div>
        ${(role === "driver" && b.status === "pending" && !isPast) ?
        `<button class="success" onclick="acceptJob('${b.booking_id}')">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
        ${ackBtn}
         
        <div style="display:flex; gap:5px;">
           <div style="width:100%">${adminAssignBtn}</div>
        </div>

        ${((b.booked_by === userId || b.driver_line_id === userId || role === "admin") && !isCancelled) ?
        `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
      </div>
    `;
};

// [ADDED] Render Series Card
const renderSeriesCard = (group) => {
    const items = group.items;
    const total = items.length;
    const pendingCount = items.filter(i => i.status === 'pending').length;
    const confirmedCount = items.filter(i => i.status === 'confirmed').length;
    
    // Check if Driver can accept ALL (must have some pending, and user is driver)
    const canAcceptAll = (role === "driver" && pendingCount > 0);
    
    // Generate sub-cards
    const subCards = items.map(renderCard).join("");
    
    return `
      <div class="card series-card">
         <div class="series-header">
            <div>
               <b>üì¶ ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (${total} ‡∏ß‡∏±‡∏ô)</b><br>
               <span style="font-size:12px; color:#666;">${items[0].pickup_location} ...</span>
            </div>
            <div style="text-align:right; font-size:12px;">
               <span style="color:#28a745">‚úÖ ${confirmedCount}</span> | 
               <span style="color:#f39c12">‚è≥ ${pendingCount}</span>
            </div>
         </div>
         ${canAcceptAll ? `<button class="success" style="margin-bottom:10px;" onclick="acceptSeries('${group.batch_id}')">‚úÖ‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${pendingCount} ‡∏ß‡∏±‡∏ô)</button>` : ''}
         <button class="secondary" onclick="document.getElementById('series_${group.batch_id}').style.display = (document.getElementById('series_${group.batch_id}').style.display=='none'?'block':'none')">
            üìú ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏ã‡πà‡∏≠‡∏ô
         </button>
         <div id="series_${group.batch_id}" style="display:none; margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
            ${subCards}
         </div>
      </div>
    `;
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toggle ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤
function togglePast() {
    const area = document.getElementById("pastArea");
    if (area.style.display === "none") {
        area.style.display = "block";
    } else {
        area.style.display = "none";
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toggle ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
function toggleFailed() {
    const area = document.getElementById("failedArea");
    if (area.style.display === "none") {
        area.style.display = "block";
    } else {
        area.style.display = "none";
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Toggle ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
function toggleCancelled() {
    const area = document.getElementById("cancelledArea");
    if (area.style.display === "none") {
        area.style.display = "block";
    } else {
        area.style.display = "none";
    }
}

function openAssignModal(id) {
    currentBookingIdToAssign = id;
    const sel = document.getElementById("modal_driver_select");
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö --</option>';
    if(driverListCache.length === 0) loadDriversList();
    driverListCache.forEach(d => {
        sel.innerHTML += `<option value="${d.id}">${d.name}</option>`;
    });
    document.getElementById("assignModal").style.display = "flex";
}

function closeAssignModal() {
    document.getElementById("assignModal").style.display = "none";
    currentBookingIdToAssign = null;
}

async function confirmAssign() {
    const drvId = document.getElementById("modal_driver_select").value;
    if(!drvId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢");
     
    const selectElem = document.getElementById("modal_driver_select");
    const drvName = selectElem.options[selectElem.selectedIndex].text;
    const bookingIdToSend = currentBookingIdToAssign;

    closeAssignModal();
    if(!confirm(`‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:\n‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ: ${drvName}\n‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    toggleLoad(true);
    try {
        await gasFetch({ 
            action: "assign_driver", 
            booking_id: bookingIdToSend, 
            assign_driver_id: drvId 
        });
        alert("‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        await showHistory();
    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
        toggleLoad(false);
    }
}

async function acknowledgeJob(id) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢?")) {
    toggleLoad(true);
    await gasFetch({ action: "acknowledge_job", booking_id: id, line_user_id: userId, display_name: displayName });
    alert("‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    await showHistory();
    toggleLoad(false);
  }
}

async function becomeAdmin() {
  const code = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 6 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin:");
  if (code) {
    toggleLoad(true);
    const res = await gasFetch({ action: "verify_admin", line_user_id: userId, code: code });
    if (res.success) { alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÅ‡∏•‡πâ‡∏ß"); location.reload(); }
    else { alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); toggleLoad(false);
    }
  }
}

async function cancelAdminRole() { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { toggleLoad(true);
await gasFetch({ action: "cancel_admin", line_user_id: userId }); location.reload();
} }

async function submitBooking() {
  // [MODIFIED] Use Flatpickr dates
  const selectedDates = fpInstance.selectedDates;
  if (selectedDates.length === 0) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
  
  const bTime = document.getElementById("booking_time").value;
  if(!bTime) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤"); return; }

  toggleLoad(true);
  let actionType = "create_booking";
  if (role === "admin") actionType = "admin_create_booking";
  else if (role === "driver") actionType = "driver_create_booking";
  
  // Create Batch ID if multiple dates
  const batchId = (selectedDates.length > 1) ? (userId + "_" + Date.now()) : "";

  // [MODIFIED] Loop through all selected dates
  for (let d of selectedDates) {
      // Format date manually to YYYY-MM-DD because d is a JS Date object
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;

      await gasFetch({ 
        action: actionType, 
        line_user_id: userId, 
        display_name: displayName, 
        booking_date: dateStr, // Use loop date
        booking_time: bTime, 
        vehicle_type: document.getElementById("vehicle_type").value, 
        passenger_count: document.getElementById("passenger_count").value, 
        pickup_location: document.getElementById("pickup_location").value, 
        dropoff_location: document.getElementById("dropoff_location").value, 
        remark: document.getElementById("remark").value,
        duration: document.getElementById("duration").value,
        contact_mobile: document.getElementById("contact_mobile").value,
        assign_driver_id: document.getElementById("assign_driver_id").value,
        batch_id: batchId // Send batch_id
      });
  }

  // After loop finishes
  document.getElementById("formBox").style.display = "none"; 
  // Reset form
  document.getElementById("remark").value = "";
  document.getElementById("pickup_location").value = "";
  document.getElementById("dropoff_location").value = "";
  fpInstance.clear();
  
  await showHistory(); 
  toggleLoad(false);
}

async function cancelBooking(id) { if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) { toggleLoad(true); await gasFetch({ action: "cancel_booking", booking_id: id });
await showHistory(); } }
async function registerDriver() { const p = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:"); if(p) { toggleLoad(true);
await gasFetch({ action: "register_driver", line_user_id: userId, mobile_phone: p }); location.reload();
} }
async function editDriverMobile() { const p = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:"); if(p) { toggleLoad(true);
await gasFetch({ action: "register_driver", line_user_id: userId, mobile_phone: p }); alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); location.reload();
} }
async function cancelDriverRole() { if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó?")) { toggleLoad(true); await gasFetch({ action: "cancel_driver", line_user_id: userId });
location.reload(); } }
async function acceptJob(id) { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô?")) { toggleLoad(true); await gasFetch({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName });
await showHistory(); } }
function closeForm() { document.getElementById("formBox").style.display = "none"; }

// [ADDED] Accept Series Function (Helper to accept all jobs in a batch)
async function acceptSeries(batchId) {
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ?")) return;
    toggleLoad(true);
    
    const res = await gasFetch({ action: "get_all_bookings", line_user_id: userId });
    const jobs = res.data.filter(b => b.batch_id === batchId && b.status === 'pending');
    
    for(let job of jobs) {
       await gasFetch({ action: "accept_job", booking_id: job.booking_id, line_user_id: userId, display_name: displayName });
    }
    
    alert(`‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${jobs.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    await showHistory();
    toggleLoad(false);
}

init();

</script>
</body>
</html>
