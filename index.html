<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Vehicle Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 480px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      font-size: 1.6rem;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    .profile {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 6px;
    }

    .role {
      text-align: center;
      font-weight: bold;
      margin-bottom: 16px;
    }

    button {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      border-radius: 12px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }

    .btn-driver {
      background: #005bea;
      color: #fff;
    }

    .btn-cancel {
      background: #ff5252;
      color: #fff;
    }

    .btn-main {
      background: #00b900;
      color: #fff;
    }

    .btn-sub {
      background: #e0e0e0;
      color: #333;
    }

    .version {
      text-align: center;
      font-size: .8rem;
      color: #999;
      margin-top: 20px;
    }

    pre {
      font-size: .75rem;
      background: #eee;
      padding: 10px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<div class="container">
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h1>

  <div class="card">
    <div class="profile" id="profile">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div class="role" id="role"></div>

    <!-- toggle driver -->
    <button id="toggleBtn" onclick="toggleDriver()"></button>

    <!-- dynamic menu -->
    <div id="menuArea"></div>
  </div>

  <pre id="log"></pre>
  <div class="version" id="version"></div>
</div>

<script>
/* ===== CONFIG ===== */
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbwW2fE-_zSUp-RcbO2XWLE0ZBgtBOpl8ZWcitacFQaO1HvtW_8CY0Xrl6q0eeKeuOUcSA/exec";

/* ===== STATE ===== */
let currentRole = "user";

/* ===== UTIL ===== */
function log(msg) {
  document.getElementById("log").textContent += msg + "\n";
  console.log(msg);
}

/* ===== INIT ===== */
async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    document.getElementById("profile").innerText =
      `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${profile.displayName}`;

    await autoRegister(profile);

  } catch (err) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á login ‡πÉ‡∏´‡∏°‡πà");
    liff.logout();
    liff.login();
  }
}

/* ===== AUTO REGISTER ===== */
async function autoRegister(profile) {
  const payload = {
    action: "auto_register",
    line_user_id: profile.userId,
    display_name: profile.displayName
  };

  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  currentRole = data.role;

  render();
}

/* ===== TOGGLE DRIVER ===== */
async function toggleDriver() {
  const action =
    currentRole === "driver"
      ? "cancel_driver"
      : "become_driver";

  const profile = await liff.getProfile();

  const payload = {
    action: action,
    line_user_id: profile.userId
  };

  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  currentRole = data.role;

  alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  render();
}

/* ===== RENDER UI ===== */
function render() {
  const roleEl = document.getElementById("role");
  const btn = document.getElementById("toggleBtn");
  const menu = document.getElementById("menuArea");

  roleEl.innerText =
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " +
    (currentRole === "driver"
      ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ"
      : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ");

  // toggle button
  if (currentRole === "driver") {
    btn.innerText = "‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ";
    btn.className = "btn-cancel";
  } else {
    btn.innerText = "üöò ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ";
    btn.className = "btn-driver";
  }

  // menu buttons
  menu.innerHTML = "";

  if (currentRole === "user") {
    menu.innerHTML += `
      <button class="btn-main" onclick="alert('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡∏ó‡∏≥‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ')">
        üöó ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
      </button>
      <button class="btn-sub" onclick="alert('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á')">
        üìÑ ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
      </button>
    `;
  }

  if (currentRole === "driver") {
    menu.innerHTML += `
      <button class="btn-main" onclick="alert('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')">
        üßæ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
    `;
  }
}

/* ===== VERSION ===== */
document.getElementById("version").innerText =
  "Version: " + new Date().toLocaleString();

initLiff();
</script>

</body>
</html>
