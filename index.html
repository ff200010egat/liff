<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CAR bookings MMSC</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding:16px; background:#f0f2f5; color:#333; margin:0; position: relative; }
  .card { background:#fff; padding:16px; border-radius:12px; margin-bottom:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border:1px solid #eee; }
  .card.past-job { opacity: 0.6; background: #f8f9fa; filter: grayscale(0.5); }
  h2 { font-size:22px; color:#0a7cff; margin-bottom:5px; }
  
  .profile-container { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
  #profileImg { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); object-fit: cover; display: none; }
  
  #username { font-weight:bold; font-size:18px; }
  #roleBadge { display:inline-block; padding:3px 10px; border-radius:15px; background:#e4e6eb; font-size:12px; margin-bottom:15px; font-weight:600; }
  
  button { width:100%; padding:14px; font-size:16px; border-radius:10px; border:none; margin-bottom:8px; cursor: pointer; font-weight:bold; }
  .primary { background:#0a7cff; color:#fff; }
  .secondary { background:#e4e6eb; color:#4b4f56; }
  .success { background:#28a745; color:#fff; }
  .warning { background:#f39c12; color:#fff; }
  .danger { background:#fff1f0; color:#ff4d4f; border:1px solid #ffccc7; padding:10px; font-size:14px; }
  .loadmore { background:#f0f2f5; color:#0a7cff; border:2px dashed #0a7cff; padding:12px; font-size:15px; margin:4px 0 16px 0; }
  .loadmore:hover { background:#e8f0fe; }
  
  label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #555; }
  input, select { width:100%; padding:12px; box-sizing: border-box; font-size:16px; margin-bottom:12px; border-radius:8px; border:1px solid #ddd; background: #fff; }
  
  #formBox { display:none; }
  .val-text { font-size:15px; margin-bottom:5px; line-height: 1.4; }

  .admin-lock { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; background: #fff; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

  #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0a7cff; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:12px; font-weight:bold; color:#0a7cff;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
</div>

<div id="adminLockBtn" class="admin-lock" onclick="becomeAdmin()">üîë</div>

<div style="max-width: 500px; margin: auto;">
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
  
  <div class="profile-container">
    <img id="profileImg" src="" alt="Profile Image">
    <div id="username">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</div>
  </div>
  
  <div id="roleBadge">...</div>
  <div id="driverMobileArea" style="font-size: 14px; color: #666; margin-top: -10px; margin-bottom: 15px; font-weight: bold;"></div>

  <div id="actionArea">
    <button id="bookBtn" class="primary">...</button>
    <div id="roleToggleArea"></div> 
  </div>

  <div id="formBox" class="card">
    <h3 style="margin-top:0; color:#0a7cff;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>

    <div id="adminAssignArea" style="display:none;">
      <label>üèé ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (Admin Only)</label>
      <select id="assign_driver_id">
        <option value="">-- ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á --</option>
      </select>
    </div>
    
    <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
    <input type="date" id="booking_date">
    
    <label>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
    <input type="time" id="booking_time">
    
    <label>üöó ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
    <select id="vehicle_type">
      <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>
    
    <label>üë• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
    <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
    <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á)">
    <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)">
    
    <label>‚è± ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
    <select id="duration">
      <option value="1">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="1.5">1.30 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="2">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="2.5">2.30 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="3">3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="4">4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="5">5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="6">6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="7">7 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
      <option value="8">8 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
    </select>

    <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
    
    <button class="primary" onclick="submitBooking()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="historyBox"></div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzy7mhpOX-PF5m8cAWLjtbonpiT9fYM5J1Mv2UcL8OYaYgxt2DwkjtaTS15YIHZqxCC2w/exec";
let userId = "", role = "", mobile = "", displayName = "";

// ‚îÄ‚îÄ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤: ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö load more ‚îÄ‚îÄ
let allFilteredBookings = [];  // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á filter
const LOAD_STEP = 10;          // ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
let currentShowCount = 0;      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ

function toggleLoad(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }

function formatThaiDateTime(dateVal, timeVal) {
  if (!dateVal) return "-";
  const d = new Date(dateVal);
  const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
  const dateStr = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
  let timeStr = String(timeVal).includes("T") ? new Date(timeVal).getHours().toString().padStart(2,'0')+":"+new Date(timeVal).getMinutes().toString().padStart(2,'0') : String(timeVal).substring(0,5);
  return dateStr + " | " + timeStr + " ‡∏ô.";
}

async function init() {
  toggleLoad(true);
  try {
    await liff.init({ liffId: "2008934745-qU0fPztf" });
    if (!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userId = p.userId; displayName = p.displayName;
    
    document.getElementById("username").innerText = displayName;
    if (p.pictureUrl) {
      const pImg = document.getElementById("profileImg");
      pImg.src = p.pictureUrl;
      pImg.style.display = "block";
    }

    const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "auto_register", line_user_id: userId, display_name: displayName }) }).then(r => r.json());
    role = res.role;
    mobile = res.mobile; 
    renderUI();
    await showHistory();
  } catch (err) { alert(err); }
  toggleLoad(false);
}

function renderUI() {
  const bookBtn = document.getElementById("bookBtn");
  const roleToggleArea = document.getElementById("roleToggleArea");
  const mobileArea = document.getElementById("driverMobileArea");
  const adminArea = document.getElementById("adminAssignArea");
  const adminLockBtn = document.getElementById("adminLockBtn");
  
  if (role === "admin") {
    document.getElementById("roleBadge").innerText = "üõ°Ô∏è ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)";
    bookBtn.innerText = "‚ûï ‡∏•‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô‡∏ô‡∏≤‡∏° Admin)";
    adminArea.style.display = "block";
    loadDriversList();
    
    adminLockBtn.innerText = "üîì";
    adminLockBtn.onclick = cancelAdminRole;
  } else if (role === "driver") {
    document.getElementById("roleBadge").innerText = "üîì ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ";
    bookBtn.innerText = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á)";
    adminArea.style.display = "none";
    
    adminLockBtn.innerText = "üîë";
    adminLockBtn.onclick = becomeAdmin;
  } else {
    document.getElementById("roleBadge").innerText = "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
    bookBtn.innerText = "üìÖ ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤";
    adminArea.style.display = "none";
    
    adminLockBtn.innerText = "üîë";
    adminLockBtn.onclick = becomeAdmin;
  }

  mobileArea.innerText = (role === "driver" && mobile) ? "üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: " + mobile : "";
  bookBtn.onclick = () => { document.getElementById("formBox").style.display = "block"; window.scrollTo(0,0); };
  
  let toggleHtml = "";
  if (role === "admin") {
    toggleHtml = `<button class="secondary" style="background:#fff1f0; color:#ff4d4f;" onclick="cancelAdminRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Admin</button>`;
  } else if (role === "driver") {
    toggleHtml = `<button class="secondary" onclick="editDriverMobile()">üìû ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
                  <button class="secondary" style="background:#fff1f0; color:#ff4d4f;" onclick="cancelDriverRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  } else {
    toggleHtml = `<button class="secondary" onclick="registerDriver()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  }
  roleToggleArea.innerHTML = toggleHtml;
}

async function loadDriversList() {
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "get_drivers_list" }) }).then(r => r.json());
  if (res.success) {
    const select = document.getElementById("assign_driver_id");
    select.innerHTML = '<option value="">-- ‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á --</option>';
    res.drivers.forEach(d => {
      select.innerHTML += `<option value="${d.id}">${d.name}</option>`;
    });
  }
}

// ‚îÄ‚îÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á card ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚îÄ‚îÄ
function buildCard(b) {
  const nowDay = new Date().setHours(0,0,0,0);
  const isPast = new Date(b.booking_date).setHours(0,0,0,0) < nowDay;
  const isCancelled = b.status === "cancelled";
  let statusColor = (b.status === "pending") ? "#f39c12" : (isCancelled ? "#d9534f" : "#28a745");

  // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
  let ackBtn = "";
  if (role === "driver" && b.driver_line_id === userId && b.status === "confirmed") {
    ackBtn = `<button class="warning" onclick="acknowledgeJob('${b.booking_id}')">üëå ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</button>`;
  }

  // ‚îÄ‚îÄ ‡∏õ‡∏∏‡πà‡∏° cancel: admin ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô, driver/user ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‚îÄ‚îÄ
  let cancelBtn = "";
  if (!isCancelled) {
    if (role === "admin") {
      // admin ‚Üí cancel ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      cancelBtn = `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>`;
    } else if (b.booked_by === userId || b.driver_line_id === userId) {
      // driver ‡∏´‡∏£‡∏∑‡∏≠ user ‚Üí cancel ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
      cancelBtn = `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>`;
    }
  }

  return `
    <div class="card ${ (isPast || isCancelled) ? 'past-job' : '' }">
      <div class="val-text"><b>${b.pickup_location} ‚û°Ô∏è ${b.dropoff_location}</b></div>
      <div class="val-text">üìÖ ${formatThaiDateTime(b.booking_date, b.booking_time)}</div>
      <div class="val-text">üë§ ‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢: ${b.user_display_name} | üöó ${b.vehicle_type}</div>
      <div class="val-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span style="font-weight:bold; color:${statusColor}">${b.status.toUpperCase()} ${b.driver_name ? '('+b.driver_name+')' : ''}</span></div>
      ${(role === "driver" && b.status === "pending") ? `<button class="success" onclick="acceptJob('${b.booking_id}')">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
      ${ackBtn}
      ${cancelBtn}
    </div>
  `;
}

// ‚îÄ‚îÄ ‡∏ß‡∏≤‡∏á cards ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡πà slice ‡∏à‡∏≤‡∏Å allFilteredBookings ‡∏ï‡∏≤‡∏° currentShowCount ‚îÄ‚îÄ
function paintCards() {
  const hBox = document.getElementById("historyBox");
  const visible = allFilteredBookings.slice(0, currentShowCount);

  let html = "<h3 style='margin: 20px 0 10px 0;'>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>";
  html += visible.map(b => buildCard(b)).join("");

  // ‚îÄ‚îÄ Load More button: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô + ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚îÄ‚îÄ
  if (role === "admin" && currentShowCount < allFilteredBookings.length) {
    const remaining = allFilteredBookings.length - currentShowCount;
    html += `<button class="loadmore" onclick="loadMore()">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</button>`;
  }

  hBox.innerHTML = html;
}

// ‚îÄ‚îÄ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Load More ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° LOAD_STEP ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß re-paint ‚îÄ‚îÄ
function loadMore() {
  currentShowCount += LOAD_STEP;
  paintCards();
}

async function showHistory() {
  toggleLoad(true);
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "get_all_bookings", line_user_id: userId }) }).then(r => r.json());
  
  const nowDay = new Date().setHours(0,0,0,0);

  // filter ‡∏ï‡∏≤‡∏° role (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á)
  let filtered = (res.data || []).filter(b => {
    if (role === "admin") return true;
    if (role === "driver") return (b.booked_by === userId || b.driver_line_id === userId || b.status === "pending");
    return (b.booked_by === userId);
  });

  // reverse ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°
  filtered.reverse();

  // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô global ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö load more
  allFilteredBookings = filtered;

  if (role === "admin") {
    // admin ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    currentShowCount = LOAD_STEP;
  } else {
    // driver / user ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏°‡∏µ load more)
    currentShowCount = allFilteredBookings.length;
  }

  paintCards();
  toggleLoad(false);
}

async function acknowledgeJob(id) {
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢?")) {
    toggleLoad(true);
    await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "acknowledge_job", booking_id: id, line_user_id: userId, display_name: displayName }) });
    alert("‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    await showHistory();
    toggleLoad(false);
  }
}

async function becomeAdmin() {
  const code = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 6 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin:");
  if (code) {
    toggleLoad(true);
    const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "verify_admin", line_user_id: userId, code: code }) }).then(r => r.json());
    if (res.success) { alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÅ‡∏•‡πâ‡∏ß"); location.reload(); }
    else { alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); toggleLoad(false); }
  }
}

async function cancelAdminRole() { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_admin", line_user_id: userId }) }); location.reload(); } }

async function submitBooking() {
  const bDate = document.getElementById("booking_date").value;
  const bTime = document.getElementById("booking_time").value;
  if(!bDate || !bTime) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤"); return; }

  toggleLoad(true);
  let actionType = "create_booking";
  if (role === "admin") actionType = "admin_create_booking";
  else if (role === "driver") actionType = "driver_create_booking";

  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ 
    action: actionType, 
    line_user_id: userId, 
    display_name: displayName, 
    booking_date: bDate, 
    booking_time: bTime, 
    vehicle_type: document.getElementById("vehicle_type").value, 
    passenger_count: document.getElementById("passenger_count").value, 
    pickup_location: document.getElementById("pickup_location").value, 
    dropoff_location: document.getElementById("dropoff_location").value, 
    duration: document.getElementById("duration").value,
    contact_mobile: document.getElementById("contact_mobile").value,
    assign_driver_id: document.getElementById("assign_driver_id").value 
  }) }).then(r => r.json());
  
  if (res.success) { 
    document.getElementById("formBox").style.display = "none"; 
    await showHistory(); 
  }
  toggleLoad(false);
}

async function cancelBooking(id) { if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_booking", booking_id: id }) }); await showHistory(); } }
async function registerDriver() { const p = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:"); if(p) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: p }) }); location.reload(); } }
async function editDriverMobile() { const p = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:"); if(p) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: p }) }); alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); location.reload(); } }
async function cancelDriverRole() { if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_driver", line_user_id: userId }) }); location.reload(); } }
async function acceptJob(id) { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName }) }); await showHistory(); } }
function closeForm() { document.getElementById("formBox").style.display = "none"; }

init();
</script>
</body>
</html>
