<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding:16px; background:#f0f2f5; color:#333; margin:0; }
  .card { background:#fff; padding:16px; border-radius:12px; margin-bottom:12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); border:1px solid #eee; }
  .card.past-job { opacity: 0.65; background: #f8f9fa; border: 1px dashed #ccc; }
  h2 { font-size:22px; color:#0a7cff; margin-bottom:5px; }
  #username { font-weight:bold; font-size:18px; }
  #roleBadge { display:inline-block; padding:3px 10px; border-radius:15px; background:#e4e6eb; font-size:12px; margin-bottom:15px; font-weight:600; }
  
  button { width:100%; padding:14px; font-size:16px; border-radius:10px; border:none; margin-bottom:10px; cursor: pointer; font-weight:bold; }
  .primary { background:#0a7cff; color:#fff; }
  .secondary { background:#e4e6eb; color:#4b4f56; }
  .success { background:#28a745; color:#fff; margin-top:10px; }
  
  input, select { width:100%; padding:12px; box-sizing: border-box; font-size:16px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd; }
  #formBox { display:none; }
  .label-text { font-size:11px; color:#8c939d; text-transform:uppercase; margin-top:8px; font-weight: bold; }
  .val-text { font-size:15px; margin-bottom:4px; line-height: 1.4; }
  .status-badge { font-weight: bold; padding: 2px 8px; border-radius: 5px; font-size: 13px; }

  #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0a7cff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:10px; font-weight:bold; color:#0a7cff;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
</div>

<div style="max-width: 500px; margin: auto;">
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
  <div id="username">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</div>
  <div id="roleBadge">...</div>

  <div id="actionArea">
    <button id="bookBtn" class="primary">...</button>
  </div>

  <div id="formBox" class="card">
    <h3 style="margin-top:0;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
    <input type="date" id="booking_date">
    <input type="time" id="booking_time">
    <select id="vehicle_type">
      <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</option>
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>
    <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
    <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
    <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
    <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
    <button class="primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="historyBox"></div>
  <div id="roleToggleArea" style="margin-top:20px;"></div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyUArXuakK9CoS5N7Mwn5zdXD-5Jif5phVGV_2o2By9ZHVYmwg7o394_Z5TFJlDQV0W0w/exec"; 
let userId = "", role = "", mobile = "", displayName = "";

function toggleLoad(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
function formatThaiDate(dateStr) {
  if (!dateStr || dateStr === "null") return "-";
  const d = new Date(dateStr);
  const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
  return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
}

function formatThaiTime(timeStr) {
  if (!timeStr || timeStr === "null") return "-";
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Date object ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á Sheet
  if (timeStr.includes("T") || timeStr.length > 8) {
     const t = new Date(timeStr);
     return t.getHours().toString().padStart(2, '0') + ":" + t.getMinutes().toString().padStart(2, '0') + " ‡∏ô.";
  }
  return timeStr.substring(0, 5) + " ‡∏ô.";
}

async function init() {
  toggleLoad(true);
  try {
    await liff.init({ liffId: "2008934745-qU0fPztf" });
    if (!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userId = p.userId; displayName = p.displayName;
    document.getElementById("username").innerText = displayName;

    const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "auto_register", line_user_id: userId, display_name: displayName }) }).then(r => r.json());
    role = res.role; mobile = res.mobile || "";
    renderUI();
    showHistory();
  } catch (err) { alert(err); }
  toggleLoad(false);
}

function renderUI() {
  const bookBtn = document.getElementById("bookBtn");
  const roleToggleArea = document.getElementById("roleToggleArea");
  document.getElementById("roleBadge").innerText = (role === "driver") ? "üîì ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
  bookBtn.innerText = (role === "driver") ? "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á" : "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
  bookBtn.onclick = () => { document.getElementById("formBox").style.display = "block"; window.scrollTo(0,0); };
  roleToggleArea.innerHTML = (role === "driver") 
    ? `<button class="secondary" style="font-size:12px;" onclick="cancelDriverRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`
    : `<button class="secondary" style="font-size:12px;" onclick="registerDriver()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
}

async function showHistory() {
  toggleLoad(true);
  const hBox = document.getElementById("historyBox");
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "get_all_bookings", line_user_id: userId }) }).then(r => r.json());
  
  const now = new Date().setHours(0,0,0,0);
  let filtered = (res.data || []).filter(b => (role === "driver") ? (b.booked_by === userId || b.driver_line_id === userId || b.status === "pending") : (b.booked_by === userId));

  hBox.innerHTML = "<h3 style='margin: 15px 0 10px 0;'>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>";
  
  if (filtered.length === 0) {
    hBox.innerHTML += "<p style='text-align:center; color:#999;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>";
  } else {
    hBox.innerHTML += filtered.reverse().map(b => {
      const bDate = new Date(b.booking_date).setHours(0,0,0,0);
      const isPast = bDate < now;
      const isCancelled = b.status === "cancelled";
      
      return `
        <div class="card ${ (isPast || isCancelled) ? 'past-job' : '' }">
          <div class="val-text"><b>${b.pickup_location} ‚û°Ô∏è ${b.dropoff_location}</b></div>
          <div class="val-text">üìÖ ${formatThaiDate(b.booking_date)} | ‚è∞ ${formatThaiTime(b.booking_time)}</div>
          <div class="val-text">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${b.user_display_name} | üöó ${b.vehicle_type}</div>
          <div class="val-text">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="status-badge" style="color:${b.status === 'pending' ? '#f39c12' : '#28a745'}">
              ${b.status.toUpperCase()} ${b.driver_name ? '('+b.driver_name+')' : ''}
            </span>
          </div>
          ${(role === "driver" && b.status === "pending") ? `<button class="success" onclick="acceptJob('${b.booking_id}')">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
        </div>
      `;
    }).join("");
  }
  toggleLoad(false);
}

async function submitBooking() {
  const fields = ["booking_date", "booking_time", "pickup_location", "dropoff_location"];
  for (let f of fields) if (!document.getElementById(f).value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
  
  toggleLoad(true);
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action: role === "driver" ? "driver_create_booking" : "create_booking",
      line_user_id: userId, display_name: displayName,
      booking_date: document.getElementById("booking_date").value,
      booking_time: document.getElementById("booking_time").value,
      vehicle_type: document.getElementById("vehicle_type").value,
      passenger_count: document.getElementById("passenger_count").value,
      pickup_location: document.getElementById("pickup_location").value,
      dropoff_location: document.getElementById("dropoff_location").value,
      contact_mobile: document.getElementById("contact_mobile").value
    })
  }).then(r => r.json());
  if (res.success) { document.getElementById("formBox").style.display = "none"; showHistory(); }
  toggleLoad(false);
}

async function registerDriver() {
  const phone = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");
  if (!phone) return;
  toggleLoad(true);
  await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: phone }) });
  location.reload();
}

async function cancelDriverRole() { if (confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_driver", line_user_id: userId }) }); location.reload(); } }
async function acceptJob(id) { if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName }) }); showHistory(); } }
function closeForm() { document.getElementById("formBox").style.display = "none"; }

init();
</script>
</body>
</html>
