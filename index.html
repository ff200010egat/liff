<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>LIFF Register</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px; margin-top: 10px; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>
<body>

<h2>LIFF Register</h2>
<p id="version"></p>

<button onclick="registerUser()">Register User</button>
<button onclick="forceLogout()">Force Logout</button>

<pre id="log"></pre>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbzlgw-ZHCEH9tMPjEY00u4etK-WkNhwMjXtYVRqLKbdEC2eFSQOKx-h7Q7BMMnM8sGCUQ/exec";

/* version stamp */
document.getElementById("version").innerText =
  "Version: " + new Date().toISOString();

/* ================= LOG ================= */
function log(msg) {
  document.getElementById("log").textContent += msg + "\n";
  console.log(msg);
}

/* ================= INIT LIFF ================= */
async function initLiff() {
  log("init liff...");

  try {
    await liff.init({ liffId: LIFF_ID });
    log("liff ready");

    if (!liff.isLoggedIn()) {
      log("not logged in ‚Üí redirect login");
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    log("userId: " + profile.userId);
    log("name: " + profile.displayName);

  } catch (err) {
    console.error(err);
    log("init error: " + err.message);

    // üî• TOKEN REVOKED HANDLER
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á login ‡πÉ‡∏´‡∏°‡πà");
    liff.logout();
    liff.login();
  }
}

/* ================= REGISTER ================= */
async function registerUser() {
  try {
    const profile = await liff.getProfile();

    const payload = {
      line_user_id: profile.userId,
      display_name: profile.displayName
    };

    log("POST ‚Üí " + GAS_ENDPOINT);

    const res = await fetch(GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(payload)
    });

    log("GAS response status: " + res.status);
    const text = await res.text();
    log("GAS response text: " + text);

    alert("Register success");

  } catch (err) {
    console.error(err);
    log("register error: " + err.message);

    // üî• TOKEN REVOKED HANDLER
    if (err.message.includes("revoked")) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á login ‡πÉ‡∏´‡∏°‡πà");
      liff.logout();
      liff.login();
    }
  }
}

/* ================= FORCE LOGOUT ================= */
function forceLogout() {
  liff.logout();
  alert("Logged out ‚Äì ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ allow ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
}

/* ================= START ================= */
initLiff();
</script>

</body>
</html>
