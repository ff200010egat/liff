<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family:sans-serif; padding:16px; }
button { width:100%; padding:14px; margin:6px 0; }
</style>
</head>

<body>

<h2>ระบบจองรถ</h2>
<div id="username"></div>
<div id="role"></div>

<button id="mainBtn"></button>
<button id="subBtn"></button>

<div id="content"></div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwJoLc8Tk_UUF5sLpKEL4Kmbh_yU9oe2jNd1m0BX1Znc9gthx1H-ZbebyfVdshlhUlHTg/exec";
let userId="", role="", displayName="";

async function init() {
  await liff.init({ liffId:"2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  const p = await liff.getProfile();
  userId = p.userId;
  displayName = p.displayName;
  document.getElementById("username").innerText = displayName;

  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({ action:"auto_register", line_user_id:userId, display_name:displayName })
  }).then(r=>r.json());

  role = r.role;
  document.getElementById("role").innerText = role;
  render();
}

function render() {
  if (role === "user") {
    mainBtn.innerText = "จองรถ";
    subBtn.innerText = "ประวัติการจอง";
    subBtn.onclick = loadHistory;
  } else {
    mainBtn.innerText = "กรอกงานเอง";
    mainBtn.onclick = driverCreate;
    subBtn.style.display="none";
  }
}

async function loadHistory() {
  const r = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({ action:"get_my_bookings", line_user_id:userId })
  }).then(r=>r.json());

  let html = "";
  r.bookings.forEach(b=>{
    html += `
      <div>
        ${b.date} ${b.time}<br>
        ${b.from} → ${b.to}<br>
        สถานะ: ${b.status}
        ${b.status==="pending" ? `<button onclick="cancel('${b.booking_id}')">ยกเลิก</button>`:""}
      </div><hr>`;
  });
  content.innerHTML = html;
}

async function cancel(id) {
  if (!confirm("ยืนยันยกเลิก?")) return;
  await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({ action:"cancel_booking", booking_id:id, line_user_id:userId })
  });
  loadHistory();
}

function driverCreate() {
  alert("TODO: ใช้ form เดิม แต่เปลี่ยน action เป็น driver_create_booking");
}

init();
</script>
</body>
</html>
