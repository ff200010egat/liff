<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 16px;
  background: #f5f5f5;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}
h1 {
  margin: 0 0 8px;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
  margin-top: 8px;
}
.primary {
  background: #0a7cff;
  color: #fff;
  font-size: 18px;
  padding: 18px;
}
.secondary {
  background: #e0e0e0;
}
.danger {
  background: #ff5252;
  color: #fff;
}
input, select {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
.hidden { display: none; }
</style>
</head>

<body>

<div class="card">
  <h1>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h1>
  <div id="displayName"></div>
  <div id="roleText"></div>
</div>

<div class="card hidden" id="driverInfo">
  <div>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: <span id="driverPhone"></span></div>
  <button class="secondary" onclick="editPhone()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
  <button class="danger" onclick="cancelDriver()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<div class="card">
  <button class="primary" onclick="openBooking()">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>

  <button id="historyBtn" class="secondary hidden" onclick="viewHistory()">
    ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  </button>

  <button id="jobBtn" class="secondary hidden" onclick="viewJobs()">
    ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  </button>

  <button id="registerDriverBtn" class="secondary hidden" onclick="registerDriver()">
    ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
  </button>
</div>

<!-- DRIVER REGISTER POPUP -->
<div class="card hidden" id="driverPopup">
  <h3>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</h3>
  <input type="tel" id="driverMobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ">
  <button class="primary" onclick="saveDriver()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="secondary" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<script>
/* üî¥ ‡πÅ‡∏Å‡πâ ENDPOINT ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwhB_tKrKeR7dqE1ckTWyIjut4_x4wuo9zGQWfgaijhhaLSOL1M5Ge7T7Rv8si6Y2GpMg/exec";

let userId = "";
let role = "";
let mobile = "";

async function init() {
  await liff.init({ liffId: "2008934745-qU0fPztf" });

  const profile = await liff.getProfile();
  userId = profile.userId;
  displayName.innerText = profile.displayName;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:profile.displayName
    })
  }).then(r=>r.json());

  role = res.role;
  mobile = res.mobile;

  roleText.innerText =
    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + (role === "driver" ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ");

  if (role === "driver") {
    driverInfo.classList.remove("hidden");
    driverPhone.innerText = mobile || "-";
    jobBtn.classList.remove("hidden");
  } else {
    historyBtn.classList.remove("hidden");
    registerDriverBtn.classList.remove("hidden");
  }
}

function registerDriver() {
  driverPopup.classList.remove("hidden");
}

function closePopup() {
  driverPopup.classList.add("hidden");
}

async function saveDriver() {
  if (!driverMobile.value) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
    return;
  }
  await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:driverMobile.value
    })
  });
  alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  location.reload();
}

async function editPhone() {
  const newPhone = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠", mobile);
  if (!newPhone) return;

  await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:newPhone
    })
  });
  location.reload();
}

async function cancelDriver() {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ?")) return;
  await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"cancel_driver",
      line_user_id:userId
    })
  });
  location.reload();
}

/* navigation (placeholder) */
function openBooking(){ alert("‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ"); }
function viewHistory(){ alert("‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"); }
function viewJobs(){ alert("‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ"); }

init();
</script>

</body>
</html>
