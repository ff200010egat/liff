<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: sans-serif; background:#f2f4f7; padding:16px; }
.card { background:#fff; padding:16px; border-radius:14px; margin-bottom:16px; }
button { width:100%; padding:14px; font-size:18px; margin-top:10px; border-radius:12px; border:none; }
.primary { background:#007aff; color:#fff; font-size:22px; }
.secondary { background:#e9ecef; }
.danger { background:#ff3b30; color:#fff; }
.hidden { display:none; }
input,select { width:100%; padding:12px; margin-top:8px; }
</style>
</head>

<body>

<div class="card">
  <h2>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
  <div id="userName"></div>
  <div id="userRole"></div>
</div>

<div class="card">
  <button id="mainBtn" class="primary" onclick="openMain()">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
  <button id="historyBtn" class="secondary hidden">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button id="jobsBtn" class="secondary hidden">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>

<div class="card" id="driverRegisterCard">
  <button class="secondary" onclick="showDriverRegister()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<div class="card hidden" id="driverPanel">
  <input id="driverPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" />
  <button class="secondary" onclick="saveDriver()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå</button>
  <button class="danger" onclick="cancelDriver()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<div class="card hidden" id="bookingForm">
  <h3>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h3>
  <input type="date" id="bookingDate" />
  <input type="time" id="bookingTime" />
  <select id="vehicleType">
    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
    <option>‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option>‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option>‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
  </select>
  <input id="passengerCount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£" />
  <input id="pickupLocation" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" />
  <input id="dropoffLocation" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á" />
  <input id="contactMobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" />
  <button class="primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<script>
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyWXRa1daZgWI0EzgMYPew6TLn87Nn9kUO1kZtRrQSBqsbqQU0PHsmihW94cmgHp34r9A/exec";

let profile = {};
let role = "user";

async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { liff.login(); return; }

  profile = await liff.getProfile();
  document.getElementById("userName").innerText = profile.displayName;

  const r = await post("auto_register");
  role = r.role;
  render();
}

init();

async function post(action, data={}) {
  const res = await fetch(GAS_ENDPOINT, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action,
      line_user_id: profile.userId,
      display_name: profile.displayName,
      ...data
    })
  });
  return res.json();
}

function render() {
  document.getElementById("userRole").innerText =
    role === "driver" ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

  historyBtn.classList.toggle("hidden", role !== "user");
  jobsBtn.classList.toggle("hidden", role !== "driver");
  driverRegisterCard.classList.toggle("hidden", role === "driver");
  driverPanel.classList.toggle("hidden", role !== "driver");

  mainBtn.innerText = role === "driver" ? "‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
}

function openMain() {
  if (role === "user") bookingForm.classList.toggle("hidden");
}

function showDriverRegister() {
  driverPanel.classList.remove("hidden");
}

async function saveDriver() {
  await post("register_driver", { mobile_phone: driverPhone.value });
  role = "driver";
  render();
}

async function cancelDriver() {
  await post("cancel_driver");
  role = "user";
  render();
}

async function submitBooking() {
  const r = await post("create_booking", {
    booking_date: bookingDate.value,
    booking_time: bookingTime.value,
    vehicle_type: vehicleType.value,
    passenger_count: passengerCount.value,
    pickup_location: pickupLocation.value,
    dropoff_location: dropoffLocation.value,
    contact_mobile: contactMobile.value
  });
  alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏´‡∏±‡∏™ " + r.booking_id);
  bookingForm.classList.add("hidden");
}
</script>

</body>
</html>
