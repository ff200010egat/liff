<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { margin:0; font-family:system-ui; background:#f4f6f8; }
.container { padding:16px; }

.card {
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:14px;
}

h2 { margin:0; }
.role { margin-top:6px; font-weight:bold; }

button {
  width:100%;
  border:none;
  border-radius:14px;
  margin-top:10px;
}

.big {
  padding:22px;
  font-size:20px;
  background:#0a7cff;
  color:#fff;
}

.normal {
  padding:14px;
  font-size:16px;
  background:#e0e0e0;
}

.danger {
  padding:14px;
  font-size:16px;
  background:#ff5252;
  color:#fff;
}

input, select {
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  border-radius:10px;
}

.hidden { display:none; }
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="card">
  <h2>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
  <div id="userName"></div>
  <div id="userRole" class="role"></div>
</div>

<!-- DRIVER INFO -->
<div class="card hidden" id="driverBox">
  üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: <span id="driverPhone"></span>
  <button class="normal" onclick="editPhone()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
  <button class="danger" onclick="cancelDriver()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<!-- ACTION -->
<div class="card">
  <button id="mainBtn" class="big"></button>
  <button id="historyBtn" class="normal hidden">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button id="registerDriverBtn" class="normal hidden"
    onclick="openDriverPopup()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<!-- BOOKING FORM -->
<div class="card hidden" id="bookingForm">
  <h3>üìã ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>

  <input type="date" id="bookingDate">
  <input type="time" id="bookingTime">

  <select id="vehicleType">
    <option>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
    <option>‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option>‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option>‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
  </select>

  <input type="number" id="passengerCount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
  <input type="text" id="pickupLocation" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
  <input type="text" id="dropoffLocation" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
  <input type="tel" id="contactMobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô">

  <button class="big" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<!-- DRIVER POPUP -->
<div class="card hidden" id="driverPopup">
  <h3>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</h3>
  <input type="tel" id="driverMobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ">
  <button class="big" onclick="saveDriver()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

</div>

<script>
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxJ_fhLTXyfTi06PLQkQ1qtFvsHq-O1vyvA2NrIXrC1Rb0DmtHw9ZLPAH0zy2EWtTk/exec";

let userId="", role="", mobile="";

async function init() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();

  const p = await liff.getProfile();
  userId = p.userId;
  userName.innerText = p.displayName;

  const res = await fetch(GAS_ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:p.displayName
    })
  }).then(r=>r.json());

  role = res.role;
  mobile = res.mobile || "";

  userRole.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + (role==="driver"?"‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ":"‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ");

  if (role==="driver") {
    mainBtn.innerText = "‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    driverBox.classList.remove("hidden");
    driverPhone.innerText = mobile;
  } else {
    mainBtn.innerText = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
    historyBtn.classList.remove("hidden");
    registerDriverBtn.classList.remove("hidden");
  }

  mainBtn.onclick = ()=> {
    if (role!=="driver") bookingForm.classList.remove("hidden");
  };
}

/* BOOKING */
async function submitBooking(){
  await fetch(GAS_ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"create_booking",
      line_user_id:userId,
      booking_date:bookingDate.value,
      booking_time:bookingTime.value,
      vehicle_type:vehicleType.value,
      passenger_count:passengerCount.value,
      pickup_location:pickupLocation.value,
      dropoff_location:dropoffLocation.value,
      contact_mobile:contactMobile.value
    })
  });
  alert("‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  bookingForm.classList.add("hidden");
}

/* DRIVER */
function openDriverPopup(){ driverPopup.classList.remove("hidden"); }

async function saveDriver(){
  await fetch(GAS_ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:driverMobile.value
    })
  });
  location.reload();
}

async function editPhone(){
  const p = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", mobile);
  if(!p) return;
  await fetch(GAS_ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:p
    })
  });
  location.reload();
}

async function cancelDriver(){
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ?")) return;
  await fetch(GAS_ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"cancel_driver",
      line_user_id:userId
    })
  });
  location.reload();
}

init();
</script>
</body>
</html>
