<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: sans-serif;
  padding: 16px;
}
h1 {
  font-size: 24px;
  margin-bottom: 6px;
}
.big-btn {
  width: 100%;
  padding: 18px;
  font-size: 20px;
  margin-bottom: 12px;
}
.btn {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  margin-bottom: 10px;
}
.hidden {
  display: none;
}
.card {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 8px;
}
.status {
  font-size: 13px;
  color: #666;
}
</style>
</head>

<body>

<h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h1>
<div id="username"></div>
<div id="role"></div>

<button class="big-btn" id="mainBtn"></button>
<button class="btn" id="secondBtn"></button>

<button class="btn" id="registerDriverBtn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
<button class="btn hidden" id="cancelDriverBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>

<!-- ===== FORM BOOKING ===== -->
<div id="bookingForm" class="hidden">
  <h3>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>
  <input type="date" id="bDate"><br><br>
  <input type="time" id="bTime"><br><br>

  <select id="vehicle">
    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
    <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
  </select><br><br>

  <input placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£" id="passenger"><br><br>
  <input placeholder="‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á / ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" id="pickup"><br><br>
  <input placeholder="‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á / ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á" id="dropoff"><br><br>
  <input placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô" id="contact"><br><br>

  <button class="btn" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<!-- ===== LIST ===== -->
<div id="list"></div>

<script>
/* ================= CONFIG ================= */
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwZAoGzazOvMdaPfY-Vc7gLDxujc7KZLtxOM-V7VnZ3UOD6OIpAmyhctJLT3gZzcqTNoA/exec";
let profile = {};
let currentRole = "user";

/* ================= HELPER ================= */
async function post(data) {
  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    body: JSON.stringify(data)
  });
  return res.json();
}

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: "2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  profile = await liff.getProfile();

  document.getElementById("username").innerText =
    "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + profile.displayName;

  await post({
    action: "auto_register",
    line_user_id: profile.userId,
    display_name: profile.displayName
  });

  // üëâ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏°‡∏ï‡∏¥ role = user
  // (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ API get_role ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
  currentRole = "user";

  renderUI();
}

/* ================= UI ================= */
function renderUI() {
  const mainBtn = document.getElementById("mainBtn");
  const secondBtn = document.getElementById("secondBtn");

  document.getElementById("role").innerText =
    currentRole === "driver" ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

  if (currentRole === "user") {
    mainBtn.innerText = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
    mainBtn.onclick = () => {
      document.getElementById("bookingForm").classList.toggle("hidden");
      document.getElementById("list").innerHTML = "";
    };

    secondBtn.innerText = "‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
    secondBtn.onclick = loadUserBookings;

    secondBtn.classList.remove("hidden");
    document.getElementById("cancelDriverBtn").classList.add("hidden");

  } else {
    mainBtn.innerText = "‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
    mainBtn.onclick = loadDriverJobs;

    secondBtn.classList.add("hidden");
    document.getElementById("cancelDriverBtn").classList.remove("hidden");
  }
}

/* ================= ACTIONS ================= */

// ===== CREATE BOOKING =====
function submitBooking() {
  post({
    action: "create_booking",
    line_user_id: profile.userId,
    booking_date: bDate.value,
    booking_time: bTime.value,
    vehicle_type: vehicle.value,
    passenger_count: passenger.value,
    pickup_location: pickup.value,
    dropoff_location: dropoff.value,
    contact_mobile: contact.value
  }).then(() => {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    document.getElementById("bookingForm").classList.add("hidden");
  });
}

// ===== USER HISTORY =====
async function loadUserBookings() {
  document.getElementById("bookingForm").classList.add("hidden");

  const list = document.getElementById("list");
  list.innerHTML = "<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</h3>";

  const data = await post({
    action: "get_user_bookings",
    line_user_id: profile.userId
  });

  if (data.length === 0) {
    list.innerHTML += "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>";
    return;
  }

  data.forEach(b => {
    list.innerHTML += `
      <div class="card">
        <b>${b[2]} ${b[3]}</b><br>
        ${b[6]} ‚Üí ${b[7]}<br>
        ‡∏£‡∏ñ: ${b[4]} | ‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£: ${b[5]}<br>
        <span class="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${b[9]}</span>
      </div>
    `;
  });
}

// ===== DRIVER JOBS (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß) =====
async function loadDriverJobs() {
  const list = document.getElementById("list");
  list.innerHTML = "<h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>";

  const data = await post({ action: "get_driver_jobs" });

  list.innerHTML += "<h4>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô</h4>";
  data.upcoming.forEach(b => {
    list.innerHTML += `
      <div class="card">
        ${b[2]} ${b[3]}<br>
        ${b[6]} ‚Üí ${b[7]}
      </div>`;
  });

  list.innerHTML += "<h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h4>";
  data.history.forEach(b => {
    list.innerHTML += `
      <div class="card">
        ${b[2]} ${b[3]}<br>
        ${b[6]} ‚Üí ${b[7]}
      </div>`;
  });
}

/* ================= START ================= */
init();
</script>

</body>
</html>
