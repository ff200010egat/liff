<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>LIFF Register</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px; margin-top: 10px; width:100%; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>
<body>

<h2>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h2>
<p id="version"></p>

<div>
  <b id="name">-</b><br>
  <span id="role">-</span>
</div>

<button id="driverBtn" onclick="registerDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>

<pre id="log"></pre>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbzp3MIRbTf17lnZF0vjM9NcLW3REPl4V7StFO9ZFLLd86-TxFOjw_lrKNAi_Xj23Gpaag/exec";

/* version stamp */
document.getElementById("version").innerText =
  "Version: " + new Date().toISOString();

/* ================= LOG ================= */
function log(msg) {
  document.getElementById("log").textContent += msg + "\n";
  console.log(msg);
}

/* ================= INIT LIFF ================= */
async function initLiff() {
  log("init liff...");

  try {
    await liff.init({ liffId: LIFF_ID });
    log("liff ready");

    if (!liff.isLoggedIn()) {
      log("not logged in ‚Üí redirect login");
      liff.login();
      return;
    }

    let profile;
    try {
      profile = await liff.getProfile();
    } catch (e) {
      // fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rich Menu
      const token = liff.getDecodedIDToken();
      profile = {
        userId: token.sub,
        displayName: token.name || "LINE User"
      };
    }

    log("userId: " + profile.userId);
    log("name: " + profile.displayName);

    await autoRegister(profile);

  } catch (err) {
    console.error(err);
    log("init error: " + err.message);

    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á login ‡πÉ‡∏´‡∏°‡πà");
    liff.logout();
    liff.login();
  }
}

/* ================= AUTO REGISTER ================= */
async function autoRegister(profile) {
  const payload = {
    action: "auto_register",
    line_user_id: profile.userId,
    display_name: profile.displayName
  };

  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  log("GAS response: " + text);

  const data = JSON.parse(text);

  document.getElementById("name").innerText = data.display_name;
  document.getElementById("role").innerText =
    data.role === "driver" ? "üöó ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";

  if (data.role === "driver") {
    document.getElementById("driverBtn").style.display = "none";
  }
}

/* ================= REGISTER DRIVER ================= */
async function registerDriver() {
  const phone = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  if (!phone) return;

  const payload = {
    action: "register_driver",
    line_user_id: (await liff.getProfile()).userId,
    mobile_phone: phone
  };

  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  log("register_driver: " + text);

  alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß");
  location.reload();
}

/* ================= FORCE LOGOUT ================= */
function forceLogout() {
  liff.logout();
  alert("Logged out ‚Äì ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ allow ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
}

/* ================= START ================= */
initLiff();
</script>

</body>
</html>
