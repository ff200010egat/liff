<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: system-ui; padding:16px; background:#fafafa; }
h2 { font-size:26px; margin-bottom:6px; }
#username { font-size:20px; }
#role { font-size:18px; color:#555; margin-bottom:16px; }

button {
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
}
.primary { background:#0a7cff; color:#fff; }
.secondary { background:#e0e0e0; }
.danger { background:#e53935; color:#fff; }

input, select {
  width:100%;
  padding:12px;
  font-size:16px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

#formBox, #historyBox { display:none; }
</style>
</head>

<body>

<h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
<div id="username"></div>
<div id="role"></div>

<button id="mainBtn" class="primary"></button>
<button id="subBtn" class="secondary"></button>

<div id="driverBox"></div>

<!-- ================= FORM ================= -->
<div id="formBox">
  <h3 id="formTitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</h3>

  <input type="date" id="booking_date">
  <input type="time" id="booking_time">

  <select id="vehicle_type">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>
    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
    <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
  </select>

  <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
  <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
  <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
  <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">

  <button class="primary" onclick="submitBooking()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<!-- ================= HISTORY ================= -->
<div id="historyBox"></div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwUlt34XyQ5Ni0dcgdAByhIBqenDodTOnuNV6XcHlTtp5ExdqqXXzUXTeR86Swi8z_xNw/exec";
let userId = "";
let role = "";
let mobile = "";
let displayName = "";

async function init() {
  await liff.init({ liffId:"2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  const p = await liff.getProfile();
  userId = p.userId;
  displayName = p.displayName;

  document.getElementById("username").innerText = displayName;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:displayName
    })
  }).then(r=>r.json());

  role = res.role;
  mobile = res.mobile || "";
  render();
}

function render() {
  document.getElementById("role").innerText =
    role === "driver"
      ? "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ"
      : "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

  const driverBox = document.getElementById("driverBox");
  driverBox.innerHTML = "";

  if (role === "driver") {
    mainBtn.innerText = "‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á";
    formTitle.innerText = "‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ)";

    driverBox.innerHTML = `
      <button class="secondary" onclick="editDriverMobile()">
        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
      </button>

      <button class="danger" onclick="cancelDriverRole()">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
      </button>
    `;
  } else {
    mainBtn.innerText = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
    formTitle.innerText = "‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";

    driverBox.innerHTML = `
      <button class="secondary" onclick="registerDriver()">
        ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
      </button>
    `;
  }

  mainBtn.onclick = showForm;
  subBtn.innerText = "‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
  subBtn.onclick = showHistory;
}

/* ================= REGISTER DRIVER (üî• FIXED) ================= */
async function registerDriver() {
  const phone = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ");

  if (!phone) return;

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action: "register_driver",
      line_user_id: userId,
      mobile_phone: phone.trim()
    })
  }).then(r => r.json());

  if (res.success) {
    alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    role = "driver";
    mobile = phone.trim();
    render();
  } else {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  }
}

function showForm() {
  formBox.style.display = "block";
  historyBox.style.display = "none";
  contact_mobile.value = mobile;
}

function closeForm() {
  formBox.style.display = "none";
}

async function submitBooking() {
  if (!booking_date.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
  if (!booking_time.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤");
  if (!vehicle_type.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ");
  if (!passenger_count.value || passenger_count.value <= 0)
    return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£");
  if (!pickup_location.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö");
  if (!dropoff_location.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á");
  if (!contact_mobile.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠");

  const action =
    role === "driver" ? "driver_create_booking" : "create_booking";

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action,
      line_user_id: userId,
      driver_name: displayName,
      booking_date: booking_date.value,
      booking_time: booking_time.value,
      vehicle_type: vehicle_type.value,
      passenger_count: passenger_count.value,
      pickup_location: pickup_location.value.trim(),
      dropoff_location: dropoff_location.value.trim(),
      contact_mobile: contact_mobile.value.trim()
    })
  }).then(r => r.json());

  if (res.success) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    closeForm();
    showHistory();
  } else {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
  }
}

/* ================= HISTORY ================= */
async function showHistory() {
  formBox.style.display = "none";
  historyBox.style.display = "block";
  historyBox.innerHTML = "<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>";

  const res = await fetch(ENDPOINT,{
    method:"POST",
    body:JSON.stringify({
      action:"get_my_bookings",
      line_user_id:userId
    })
  }).then(r=>r.json());

  const bookings = Array.isArray(res.data) ? res.data : [];

  if (!bookings.length) {
    historyBox.innerHTML = "<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>";
    return;
  }

  renderHistory(bookings);
}

function renderHistory(bookings) {
  const today = new Date().toISOString().slice(0,10);
  let active = [];
  let past = [];

  bookings.forEach(b => {
    if (b.status === "cancelled") past.push(b);
    else if (b.booking_date >= today) active.push(b);
    else past.push(b);
  });

  historyBox.innerHTML = `
    <h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
    ${active.length ? active.map(b => renderBooking(b, true)).join("") : "<div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>"}

    <hr style="margin:16px 0">

    <h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h3>
    ${past.length ? past.map(b => renderBooking(b, false)).join("") : "<div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô</div>"}

    <button class="secondary" onclick="closeHistory()">‡∏õ‡∏¥‡∏î</button>
  `;
}

function renderBooking(b, canCancel) {
  return `
    <div style="background:#fff;padding:12px;border-radius:10px;margin-bottom:10px;">
      <div><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ${b.booking_date} ${b.booking_time}</div>
      <div><b>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</b> ${b.pickup_location} ‚Üí ${b.dropoff_location}</div>
      <div><b>‡∏£‡∏ñ:</b> ${b.vehicle_type} | <b>‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£:</b> ${b.passenger_count}</div>
      <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${b.status}</div>
      ${
        canCancel && b.status !== "cancelled"
          ? `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>`
          : ""
      }
    </div>
  `;
}

function closeHistory() {
  historyBox.style.display = "none";
}

async function cancelBooking(id) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action: "cancel_booking",
      booking_id: id,
      line_user_id: userId
    })
  }).then(r => r.json());

  if (res.success) {
    alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    showHistory();
  } else {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
  }
}

init();
</script>

</body>
</html>
