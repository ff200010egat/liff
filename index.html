<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:sans-serif;background:#f4f4f4;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:10px}
button,input{width:100%;padding:12px;margin-top:6px;font-size:16px}
.hidden{display:none}
</style>
</head>
<body>

<h2>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>

<div class="card">
  <b id="name"></b>
</div>

<div class="card">
  <button onclick="showBooking()">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
  <button onclick="loadHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button onclick="toggleDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
</div>

<div id="booking" class="card hidden">
  <input id="date" type="date">
  <input id="time" type="time">
  <input id="pickup" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
  <input id="dropoff" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
  <input id="mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
  <button onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<div id="list" class="card hidden"></div>

<script>
const GAS = "https://script.google.com/macros/s/AKfycbyYqI1gYIowzYgcNhMouYZJ7zVpZEhoZIkatLHC82r87MG9q10eCxXx2TIIDxyNVvI2ng/exec";
let profile={};

async function init(){
  await liff.init({liffId:"2008934745-qU0fPztf"});
  if(!liff.isLoggedIn()) liff.login();

  profile = await liff.getProfile();
  name.innerText = profile.displayName;

  await post('auto_register',{
    line_user_id:profile.userId,
    display_name:profile.displayName
  });
}
init();

function post(action,data){
  return fetch(GAS,{
    method:'POST',
    body:JSON.stringify({...data,action})
  }).then(r=>r.json());
}

function showBooking(){
  booking.classList.remove('hidden');
}

async function submitBooking(){
  const res = await post('create_booking',{
    line_user_id:profile.userId,
    booking_date:date.value,
    booking_time:time.value,
    pickup_location:pickup.value,
    dropoff_location:dropoff.value,
    contact_mobile:mobile.value
  });

  if(res.success){
    alert('‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    booking.classList.add('hidden');
  }else{
    alert('‚ùå '+res.data);
  }
}

async function loadHistory(){
  const r = await post('get_my_bookings',{line_user_id:profile.userId});
  list.innerHTML = r.data.map(b =>
    `üìÖ ${b[2]} ${b[3]}<br>${b[6]} ‚Üí ${b[7]}`
  ).join('<hr>');
  list.classList.remove('hidden');
}

async function toggleDriver(){
  const phone = prompt('‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
  if(!phone) return;
  await post('register_driver',{
    line_user_id:profile.userId,
    mobile_phone:phone
  });
  alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
}
</script>
</body>
</html>
