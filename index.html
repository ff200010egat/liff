<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f6f8;
    }
    h1 {
      text-align: center;
      margin-bottom: 8px;
    }
    .center {
      text-align: center;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    button {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      margin-top: 8px;
    }
    .primary {
      background: #1e88e5;
      color: #fff;
      font-size: 20px;
      padding: 18px;
    }
    .secondary {
      background: #e0e0e0;
    }
    .danger {
      background: #e53935;
      color: #fff;
    }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 6px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    label {
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body>

<h1>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h1>

<div class="center">
  <div id="displayName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <div id="roleText"></div>
</div>

<!-- HOME -->
<div id="home" class="card hidden">
  <button class="primary" onclick="showBookingForm()">
    ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
  </button>

  <button id="historyBtn" class="secondary hidden">
    ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  </button>

  <button id="driverJobsBtn" class="secondary hidden">
    ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  </button>

  <button id="registerDriverBtn" class="secondary hidden" onclick="registerDriver()">
    ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
  </button>

  <button id="cancelDriverBtn" class="danger hidden" onclick="cancelDriver()">
    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
  </button>
</div>

<!-- BOOKING FORM -->
<div id="bookingForm" class="card hidden">
  <h3>üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
  <input type="date" id="booking_date">

  <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
  <input type="time" id="booking_time">

  <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏ñ</label>
  <select id="vehicle_type">
    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
    <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
  </select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£</label>
  <input type="number" id="passenger_count" min="1">

  <label>‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö)</label>
  <input type="text" id="pickup_location">

  <label>‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á)</label>
  <input type="text" id="dropoff_location">

  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô</label>
  <input type="tel" id="contact_mobile">

  <button class="primary" onclick="submitBooking()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á</button>
  <button class="secondary" onclick="backHome()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbwW9WeiJfPVvjkbdhTAZKC1u0dZaVBrVqqs0cAVk_8Daew7HbKruyHgxZhb0lVUiJ0UgA/exec"; // üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

let userProfile = {};
let userRole = "user";

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  try {
    userProfile = await liff.getProfile();
  } catch (err) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á login ‡πÉ‡∏´‡∏°‡πà");
    liff.logout();
    liff.login();
    return;
  }

  document.getElementById("displayName").innerText =
    "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + userProfile.displayName;

  autoRegister();
}

init();

/* ================= API ================= */
async function postToGAS(payload) {
  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* ================= USER ================= */
async function autoRegister() {
  await postToGAS({
    action: "auto_register",
    line_user_id: userProfile.userId,
    display_name: userProfile.displayName
  });

  // default = user
  userRole = "user";
  updateUI();
}

function updateUI() {
  document.getElementById("home").classList.remove("hidden");

  document.getElementById("roleText").innerText =
    userRole === "driver"
      ? "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ"
      : "‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

  document.getElementById("historyBtn").classList.toggle("hidden", userRole !== "user");
  document.getElementById("driverJobsBtn").classList.toggle("hidden", userRole !== "driver");
  document.getElementById("registerDriverBtn").classList.toggle("hidden", userRole === "driver");
  document.getElementById("cancelDriverBtn").classList.toggle("hidden", userRole !== "driver");
}

/* ================= DRIVER ================= */
async function registerDriver() {
  const mobile = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ");
  if (!mobile) return;

  await postToGAS({
    action: "register_driver",
    line_user_id: userProfile.userId,
    mobile
  });

  userRole = "driver";
  updateUI();
}

async function cancelDriver() {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ?")) return;

  await postToGAS({
    action: "cancel_driver",
    line_user_id: userProfile.userId
  });

  userRole = "user";
  updateUI();
}

/* ================= BOOKING ================= */
function showBookingForm() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("bookingForm").classList.remove("hidden");
}

function backHome() {
  document.getElementById("bookingForm").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

async function submitBooking() {
  const payload = {
    action: "create_booking",
    line_user_id: userProfile.userId,
    display_name: userProfile.displayName,
    booking_date: booking_date.value,
    booking_time: booking_time.value,
    vehicle_type: vehicle_type.value,
    passenger_count: passenger_count.value,
    pickup_location: pickup_location.value,
    dropoff_location: dropoff_location.value,
    contact_mobile: contact_mobile.value
  };

  const res = await postToGAS(payload);

  if (res.success) {
    alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n‡∏£‡∏´‡∏±‡∏™: " + res.booking_id);
    backHome();
  } else {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
}
</script>

</body>
</html>
