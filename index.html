<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: system-ui; padding:16px; background:#fafafa; }
h2 { font-size:26px; margin-bottom:6px; }
#username { font-size:20px; }
#role { font-size:18px; color:#555; margin-bottom:16px; }

button {
  width:100%;
  padding:16px;
  font-size:18px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
}
.primary { background:#0a7cff; color:#fff; }
.secondary { background:#e0e0e0; }
.danger { background:#e53935; color:#fff; }

input, select {
  width:100%;
  padding:12px;
  font-size:16px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

#formBox, #historyBox { display:none; }
</style>
</head>

<body>

<h2>ระบบจองรถ หก-มน.</h2>
<div id="username"></div>
<div id="role"></div>

<button id="mainBtn" class="primary"></button>
<button id="subBtn" class="secondary"></button>

<div id="driverBox"></div>

<!-- ================= FORM ================= -->
<div id="formBox">
  <h3 id="formTitle">ฟอร์มจองรถ</h3>

  <input type="date" id="booking_date">
  <input type="time" id="booking_time">

  <select id="vehicle_type">
    <option value="">-- เลือกรถ --</option>
    <option value="ไม่ระบุ">ไม่ระบุ</option>
    <option value="รถเก๋ง">รถเก๋ง</option>
    <option value="รถกระบะ">รถกระบะ</option>
    <option value="รถตู้">รถตู้</option>
  </select>

  <input type="number" id="passenger_count" placeholder="จำนวนผู้โดยสาร">
  <input type="text" id="pickup_location" placeholder="จุดรับ">
  <input type="text" id="dropoff_location" placeholder="จุดส่ง">
  <input type="text" id="contact_mobile" placeholder="เบอร์ติดต่อ">

  <button class="primary" onclick="submitBooking()">บันทึก</button>
  <button class="secondary" onclick="closeForm()">ยกเลิก</button>
</div>

<div id="historyBox"></div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbw0jHGbDnPhOqE8NaqymxvdY0vuq0XaNVA8pqWBgu2zT4dhqNN4J1CvDPjIaJwWVJLgWg/exec";
let userId = "";
let role = "";
let mobile = "";
let displayName = "";

async function init() {
  await liff.init({ liffId:"2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  const p = await liff.getProfile();
  userId = p.userId;
  displayName = p.displayName;
  document.getElementById("username").innerText = displayName;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"auto_register",
      line_user_id:userId,
      display_name:displayName
    })
  }).then(r=>r.json());

  role = res.role;
  mobile = res.mobile || "";
  render();
}

function render() {
  document.getElementById("role").innerText =
    role === "driver"
      ? "บทบาท: พนักงานขับรถ"
      : "บทบาท: ผู้ใช้งานทั่วไป";

  const driverBox = document.getElementById("driverBox");
  driverBox.innerHTML = "";

  if (role === "driver") {
    mainBtn.innerText = "กรอกงานเอง";
    formTitle.innerText = "ฟอร์มกรอกงาน (พนักงานขับรถ)";
    driverBox.innerHTML = `
      <button class="secondary" onclick="editDriverMobile()">แก้ไขเบอร์โทรพนักงานขับรถ</button>
      <button class="danger" onclick="cancelDriverRole()">ยกเลิกบทบาทพนักงานขับรถ</button>
    `;
  } else {
    mainBtn.innerText = "จองรถพร้อมคนขับ";
    formTitle.innerText = "ฟอร์มจองรถพร้อมคนขับ";
    driverBox.innerHTML = `
      <button class="secondary" onclick="registerDriver()">ลงทะเบียนเป็นพนักงานขับรถ</button>
    `;
  }

  mainBtn.onclick = showForm;
  subBtn.innerText = "ดูประวัติ";
  subBtn.onclick = () => alert("TODO: หน้าประวัติการจอง");
}

function showForm() {
  document.getElementById("formBox").style.display = "block";
  document.getElementById("contact_mobile").value = mobile;
}

function closeForm() {
  document.getElementById("formBox").style.display = "none";
}

function isEmpty(v) {
  return !v || v.toString().trim() === "";
}

async function submitBooking() {
  if (isEmpty(booking_date.value)) return alert("กรุณาเลือกวันที่");
  if (isEmpty(booking_time.value)) return alert("กรุณาเลือกเวลา");
  if (isEmpty(vehicle_type.value)) return alert("กรุณาเลือกประเภทรถ");
  if (isEmpty(passenger_count.value) || passenger_count.value <= 0)
    return alert("กรุณาระบุจำนวนผู้โดยสาร");
  if (isEmpty(pickup_location.value)) return alert("กรุณาระบุจุดรับ");
  if (isEmpty(dropoff_location.value)) return alert("กรุณาระบุจุดส่ง");
  if (isEmpty(contact_mobile.value)) return alert("กรุณาระบุเบอร์ติดต่อ");

  const action = role === "driver" ? "driver_create_booking" : "create_booking";

  const res = await fetch(ENDPOINT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action,
      line_user_id: userId,
      driver_name: displayName,
      booking_date: booking_date.value,
      booking_time: booking_time.value,
      vehicle_type: vehicle_type.value,
      passenger_count: passenger_count.value,
      pickup_location: pickup_location.value.trim(),
      dropoff_location: dropoff_location.value.trim(),
      contact_mobile: contact_mobile.value.trim()
    })
  }).then(r=>r.json());

  if (res.success) {
    alert("บันทึกเรียบร้อย");
    location.reload();
  } else {
    alert("เกิดข้อผิดพลาด");
  }
}

async function registerDriver() {
  const m = prompt("กรุณาระบุเบอร์โทร");
  if (!m) return;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:m
    })
  }).then(r=>r.json());

  res.success ? location.reload() : alert("เบอร์โทรไม่ถูกต้อง");
}

async function editDriverMobile() {
  const m = prompt("กรุณาระบุเบอร์โทรใหม่");
  if (!m) return;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"register_driver",
      line_user_id:userId,
      mobile_phone:m
    })
  }).then(r=>r.json());

  res.success ? location.reload() : alert("เบอร์โทรไม่ถูกต้อง");
}

async function cancelDriverRole() {
  if (!confirm("ยืนยันยกเลิกบทบาทพนักงานขับรถ?")) return;

  const res = await fetch(ENDPOINT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"cancel_driver",
      line_user_id:userId
    })
  }).then(r=>r.json());

  res.success ? location.reload() : alert("ไม่สามารถยกเลิกได้");
}

init();
</script>

</body>
</html>
