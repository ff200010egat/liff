<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CAR Bookings</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: sans-serif; padding:16px; background:#f4f7f6; color:#333; margin:0; }
  .card { background:#fff; padding:15px; border-radius:10px; margin-bottom:12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  h2 { color:#007bff; }
  button { width:100%; padding:12px; font-size:16px; border-radius:8px; border:none; margin-bottom:8px; cursor:pointer; font-weight:bold; }
  .primary { background:#007bff; color:#fff; }
  .secondary { background:#6c757d; color:#fff; }
  .danger { background:#dc3545; color:#fff; }
  .success { background:#28a745; color:#fff; }
  input, select { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; box-sizing: border-box; }
  #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:99; justify-content:center; align-items:center; }
</style>
</head>
<body>

<div id="loading"><b>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</b></div>

<div id="mainUI">
  <h2 id="username">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h2>
  <div id="roleBadge" style="font-weight:bold; margin-bottom:10px;"></div>
  
  <button id="bookBtn" class="primary" onclick="openForm()">‚ûï ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ñ</button>
  <div id="roleToggleArea"></div>

  <div id="formBox" style="display:none;" class="card">
    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>
    <div id="adminAssignArea" style="display:none;">
      <label>‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö:</label><select id="assign_driver_id"></select>
    </div>
    <input type="date" id="booking_date">
    <input type="time" id="booking_time">
    <select id="vehicle_type">
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>
    <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
    <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
    <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
    <button class="success" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="historyBox"></div>
  <button id="loadMoreBtn" class="secondary" style="display:none; margin-top:10px;" onclick="loadMore()">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...</button>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwQ3-nw_BV7F_uFSHvc-Lx5pcZnZVn0F0YmTIVxX2IuWzSbauqaLUeUipg3RaG6tAMQRg/exec";
let userId = "", displayName = "", role = "", mobile = "";
let currentOffset = 0; const PAGE_SIZE = 10;

function toggleLoad(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }

async function init() {
  toggleLoad(true);
  try {
    await liff.init({ liffId: "2008934745-qU0fPztf" });
    if (!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userId = p.userId; displayName = p.displayName;
    document.getElementById("username").innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì " + displayName;
    currentOffset = 0;
    await fetchHistory(false);
  } catch (err) { alert("LIFF Init Error: " + err); }
  toggleLoad(false);
}

async function fetchHistory(append = false) {
  const res = await fetch(ENDPOINT, { 
    method: "POST", 
    body: JSON.stringify({ action: "get_all_bookings", line_user_id: userId, limit: PAGE_SIZE, offset: currentOffset }) 
  }).then(r => r.json());

  role = res.role; mobile = res.mobile;
  renderUI();
  renderHistoryData(res.data, append);
  
  const btn = document.getElementById("loadMoreBtn");
  if (res.hasMore) { btn.style.display = "block"; currentOffset += PAGE_SIZE; } 
  else { btn.style.display = "none"; }
}

function renderUI() {
  const area = document.getElementById("roleToggleArea");
  document.getElementById("roleBadge").innerText = "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + role.toUpperCase();
  document.getElementById("adminAssignArea").style.display = (role === "admin") ? "block" : "none";
  if (role === "admin") loadDriversList();

  if (role === "admin") {
    area.innerHTML = `<button class="danger" onclick="cancelRole('cancel_admin')">üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</button>`;
  } else if (role === "driver") {
    area.innerHTML = `<button class="danger" onclick="cancelRole('cancel_driver')">üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>`;
  } else {
    area.innerHTML = `<button class="secondary" onclick="registerDriver()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button> <button class="secondary" onclick="becomeAdmin()">‡πÄ‡∏õ‡πá‡∏ô Admin</button>`;
  }
}

function renderHistoryData(data, append) {
  const hBox = document.getElementById("historyBox");
  if (!append) hBox.innerHTML = "<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì/‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h3>";
  
  const html = data.map(b => `
    <div class="card">
      <b>üìç ${b.pickup_location} ‚û°Ô∏è ${b.dropoff_location}</b><br>
      üìÖ ${b.booking_date.substring(0,10)} | ‚è∞ ${b.booking_time}<br>
      ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b>${b.status}</b><br>
      ${(role === "driver" && b.status === "pending") ? `<button class="success" onclick="acceptJob('${b.booking_id}')">‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
      ${((b.booked_by === userId || role === "admin") && b.status !== 'cancelled') ? `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>` : ""}
    </div>
  `).join("");
  hBox.innerHTML += html;
}

async function loadMore() { toggleLoad(true); await fetchHistory(true); toggleLoad(false); }

async function cancelRole(act) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå?")) return;
  toggleLoad(true);
  await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: act, line_user_id: userId }) });
  location.reload();
}

async function registerDriver() {
  const p = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:");
  if (p) {
    toggleLoad(true);
    await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: p }) });
    location.reload();
  }
}

async function becomeAdmin() {
  const c = prompt("‡∏£‡∏´‡∏±‡∏™ Admin 6 ‡∏´‡∏•‡∏±‡∏Å:");
  if (c) {
    toggleLoad(true);
    const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "verify_admin", line_user_id: userId, code: c }) }).then(r=>r.json());
    if (res.success) location.reload(); else alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    toggleLoad(false);
  }
}

async function submitBooking() {
  toggleLoad(true);
  const data = {
    action: (role === "admin") ? "admin_create_booking" : (role === "driver" ? "driver_create_booking" : "create_booking"),
    line_user_id: userId, display_name: displayName,
    booking_date: document.getElementById("booking_date").value,
    booking_time: document.getElementById("booking_time").value,
    pickup_location: document.getElementById("pickup_location").value,
    dropoff_location: document.getElementById("dropoff_location").value,
    vehicle_type: document.getElementById("vehicle_type").value,
    contact_mobile: document.getElementById("contact_mobile").value,
    assign_driver_id: document.getElementById("assign_driver_id").value
  };
  await fetch(ENDPOINT, { method: "POST", body: JSON.stringify(data) });
  location.reload();
}

async function acceptJob(id) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName }) }); location.reload(); }
async function cancelBooking(id) { if(confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) { toggleLoad(true); await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_booking", booking_id: id }) }); location.reload(); } }
async function loadDriversList() {
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "get_drivers_list" }) }).then(r => r.json());
  const s = document.getElementById("assign_driver_id");
  s.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö--</option>' + res.drivers.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
}

function openForm() { document.getElementById("formBox").style.display = "block"; }
function closeForm() { document.getElementById("formBox").style.display = "none"; }

init();
</script>
</body>
</html>
