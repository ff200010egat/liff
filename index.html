<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      margin: 0;
      padding: 16px;
      background: #f2f4f7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
    }

    h1 {
      margin: 0;
      font-size: 24px;
      text-align: center;
    }

    .center { text-align: center; }

    .label {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    button {
      width: 100%;
      border: none;
      border-radius: 14px;
      padding: 14px;
      font-size: 18px;
      margin-top: 10px;
      cursor: pointer;
    }

    .primary {
      background: #007aff;
      color: #fff;
      font-size: 22px;
      padding: 18px;
    }

    .secondary {
      background: #e9ecef;
      color: #000;
    }

    .danger {
      background: #ff3b30;
      color: #fff;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .hidden { display: none; }

    .version {
      text-align: center;
      font-size: 12px;
      color: #999;
      margin-top: 20px;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="card center">
    <h1>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h1>
    <div id="userName">-</div>
    <div id="userRole" class="label">-</div>
  </div>

  <!-- MAIN ACTION -->
  <div class="card">
    <button id="mainBtn" class="primary" onclick="openMainAction()">
      ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö
    </button>

    <button id="historyBtn" class="secondary hidden" onclick="viewHistory()">
      ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    </button>

    <button id="jobsBtn" class="secondary hidden" onclick="viewJobs()">
      ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>

  <!-- DRIVER REGISTER (USER ONLY) -->
  <div class="card" id="driverRegisterCard">
    <button class="secondary" onclick="showDriverRegister()">
      ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
    </button>
  </div>

  <!-- DRIVER PANEL -->
  <div class="card hidden" id="driverPanel">
    <div class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
    <input id="driverPhone" placeholder="08xxxxxxxx" />
    <button class="secondary" onclick="saveDriver()">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    </button>
    <button class="danger" onclick="cancelDriver()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
    </button>
  </div>

  <!-- BOOKING FORM -->
  <div id="bookingForm" class="card hidden">
    <h3>üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>

    <input type="date" id="bookingDate" />
    <input type="time" id="bookingTime" />

    <select id="vehicleType">
      <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>

    <input type="number" id="passengerCount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£" />
    <input id="pickupLocation" placeholder="‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á / ‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö" />
    <input id="dropoffLocation" placeholder="‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á / ‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á" />
    <input id="contactMobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô" />

    <button class="primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  </div>

  <div class="version" id="version"></div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008934745-qU0fPztf";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyEDe6tW_6Lro8AOer6aBIrkm-Aiex_TFpahEOV5fPN-zwS7Ord2TF1tHtAoDjPjS44JQ/exec";
const BUILD_VERSION = new Date().toISOString();

/* ================= STATE ================= */
let profile = {};
let role = "user";

/* ================= INIT ================= */
async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  profile = await liff.getProfile();
  document.getElementById("userName").innerText = profile.displayName;

  await autoRegister();

  document.getElementById("version").innerText =
    "ver: " + BUILD_VERSION;
}

init();

/* ================= API ================= */
async function post(action, data = {}) {
  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action,
      line_user_id: profile.userId,
      display_name: profile.displayName,
      ...data
    })
  });
  return res.json();
}

/* ================= LOGIC ================= */
async function autoRegister() {
  const r = await post("auto_register");
  role = r.role;
  renderRole();
}

function renderRole() {
  document.getElementById("userRole").innerText =
    role === "driver" ? "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

  document.getElementById("historyBtn").classList.toggle("hidden", role !== "user");
  document.getElementById("jobsBtn").classList.toggle("hidden", role !== "driver");

  document.getElementById("driverRegisterCard").classList.toggle("hidden", role === "driver");
  document.getElementById("driverPanel").classList.toggle("hidden", role !== "driver");

  document.getElementById("mainBtn").innerText =
    role === "driver" ? "‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
}

function openMainAction() {
  if (role === "driver") {
    viewJobs();
  } else {
    document.getElementById("bookingForm").classList.toggle("hidden");
  }
}

function showDriverRegister() {
  document.getElementById("driverPanel").classList.remove("hidden");
}

async function saveDriver() {
  const phone = document.getElementById("driverPhone").value;
  await post("register_driver", { mobile_phone: phone });
  role = "driver";
  renderRole();
  alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
}

async function cancelDriver() {
  await post("cancel_driver");
  role = "user";
  renderRole();
  alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß");
}

async function submitBooking() {
  const data = {
    booking_date: bookingDate.value,
    booking_time: bookingTime.value,
    vehicle_type: vehicleType.value,
    passenger_count: passengerCount.value,
    pickup_location: pickupLocation.value,
    dropoff_location: dropoffLocation.value,
    contact_mobile: contactMobile.value
  };
  const r = await post("create_booking", data);
  alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏´‡∏±‡∏™: " + r.booking_id);
  document.getElementById("bookingForm").classList.add("hidden");
}

function viewHistory() {
  alert("TODO: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (user)");
}

function viewJobs() {
  alert("TODO: ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (driver)");
}
</script>

</body>
</html>
