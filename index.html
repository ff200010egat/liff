<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, -apple-system;
  background: #f2f4f7;
  margin: 0;
}
.container {
  max-width: 480px;
  margin: auto;
  padding: 16px;
}
button {
  width: 100%;
  border: none;
  border-radius: 14px;
  font-size: 1.1rem;
  padding: 16px;
  margin-top: 12px;
}
.primary {
  background: #00b900;
  color: white;
  font-size: 1.3rem;
  padding: 22px;
}
.secondary {
  background: white;
  border: 1px solid #ccc;
}
.card {
  background: white;
  padding: 16px;
  border-radius: 16px;
  margin-top: 16px;
}
.label {
  font-weight: 600;
  margin-bottom: 6px;
}
input {
  width: 100%;
  padding: 14px;
  font-size: 1rem;
  margin-top: 8px;
  border-radius: 10px;
  border: 1px solid #ccc;
}
.version {
  text-align: center;
  font-size: 0.75rem;
  color: #888;
  margin-top: 16px;
}
</style>
</head>

<body>
<div class="container">

  <!-- MAIN ACTION -->
  <button class="primary">üöó ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
  <button class="secondary">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>

  <!-- DRIVER SECTION -->
  <div class="card" id="driverSection">
    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
  </div>

  <div class="version" id="version"></div>
</div>

<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008934745-qU0fPztf";

/* üî¥ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô GAS Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const GAS_ENDPOINT =
  "https://script.google.com/macros/s/AKfycbwZC-cgly5KdUEXn9JdLlp5WU1kGn91WY9tOPRnhIICTMqTaFmf-pNCfcnDr_i8DM8SWA/exec";

/* ================= STATE ================= */
let userId = "";
let displayName = "";
let role = "";
let mobile = "";

/* ================= INIT ================= */
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;
    displayName = profile.displayName;

    const res = await fetch(GAS_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        action: "auto_register",
        line_user_id: userId,
        display_name: displayName
      })
    });

    const data = await res.json();
    role = data.role;
    mobile = data.mobile;

    renderDriverUI();
  } catch (err) {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
    console.error(err);
  }
}

/* ================= UI ================= */
function renderDriverUI() {
  const el = document.getElementById("driverSection");

  if (role !== "driver") {
    el.innerHTML = `
      <div class="label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div>
      <button onclick="registerDriver()">üßë‚Äç‚úàÔ∏è ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
    `;
  } else {
    el.innerHTML = `
      <div class="label">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
      <div>${mobile}</div>
      <button onclick="registerDriver()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
    `;
  }
}

/* ================= ACTION ================= */
async function registerDriver() {
  const phone = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)");
  if (!phone) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const res = await fetch(GAS_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({
      action: "register_driver",
      line_user_id: userId,
      mobile_phone: phone
    })
  });

  const data = await res.json();

  if (data.success) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    location.reload();
  } else {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
  }
}

/* ================= VERSION ================= */
document.getElementById("version").innerText =
  "Build: " + new Date().toLocaleString();

/* ================= START ================= */
init();
</script>
</body>
</html>
