<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding:16px; background:#f4f7f9; color:#333; margin:0; }
  .card { background:#fff; padding:18px; border-radius:15px; margin-bottom:15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border:1px solid #eaeaea; }
  h2 { font-size:24px; color:#0a7cff; margin-bottom:15px; }
  #username { font-weight:bold; font-size:18px; }
  #roleBadge { display:inline-block; padding:5px 14px; border-radius:20px; background:#dfe4ea; font-size:13px; margin-bottom:15px; font-weight:600; color:#2f3542; }
  
  button { width:100%; padding:15px; font-size:16px; border-radius:12px; border:none; margin-bottom:10px; cursor: pointer; font-weight:bold; transition: 0.2s; }
  .primary { background:#0a7cff; color:#fff; }
  .secondary { background:#f1f2f6; color:#2f3542; }
  .danger { background:#fff5f5; color:#fa5252; border: 1px solid #ffc9c9; }
  .success { background:#2ecc71; color:#fff; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
  
  input, select { width:100%; padding:13px; box-sizing: border-box; font-size:16px; margin-bottom:12px; border-radius:10px; border:1px solid #ddd; background:#fff; }
  #formBox, #historyBox { display:none; }
  .label-text { font-size:11px; color:#a4b0be; text-transform:uppercase; margin-top:8px; font-weight:bold; letter-spacing: 0.5px; }
  .val-text { font-size:15px; margin-bottom:8px; color: #2f3542; }

  /* Full Screen Loading */
  #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:10000; justify-content:center; align-items:center; flex-direction:column; }
  .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #0a7cff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p style="margin-top:15px; font-weight:bold; color:#0a7cff;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
</div>

<div style="max-width: 500px; margin: auto;">
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
  <div id="username">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì...</div>
  <div id="roleBadge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</div>

  <button id="mainBtn" class="primary"></button>
  <button id="subBtn" class="secondary"></button>
  <div id="driverActionBox"></div>

  <div id="formBox" class="card">
    <h3 style="margin-top:0;">‡∏à‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h3>
    <input type="date" id="booking_date">
    <input type="time" id="booking_time">
    <select id="vehicle_type">
      <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
      <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
      <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
      <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    </select>
    <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
    <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á)">
    <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)">
    <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
    <button class="primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <div id="historyBox"></div>
</div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycby1A-JQ67hGr4Y-pNmV6Lu2qn2NVYFcwUqgMH372J6ovDRlJVxTfw7FmV_I9HSQ8x1rbQ/exec"; // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
let userId = "", role = "", mobile = "", displayName = "";

function toggleLoading(s) { document.getElementById("loading").style.display = s ? "flex" : "none"; }

async function init() {
  toggleLoading(true);
  try {
    await liff.init({ liffId: "2008934745-qU0fPztf" });
    if (!liff.isLoggedIn()) liff.login();
    const p = await liff.getProfile();
    userId = p.userId; displayName = p.displayName;
    document.getElementById("username").innerText = displayName;

    const res = await fetch(ENDPOINT, {
      method: "POST",
      body: JSON.stringify({ action: "auto_register", line_user_id: userId, display_name: displayName })
    }).then(r => r.json());

    role = res.role; mobile = res.mobile || "";
    render();
    if(role === "driver") { showHistory(); }
  } catch (err) { alert("Initialization Error: " + err); }
  toggleLoading(false);
}

function render() {
  const mainBtn = document.getElementById("mainBtn");
  const subBtn = document.getElementById("subBtn");
  document.getElementById("roleBadge").innerText = (role === "driver") ? "üîì ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
  
  const dBox = document.getElementById("driverActionBox");
  dBox.innerHTML = "";

  if (role === "driver") {
    mainBtn.innerText = "‡∏•‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)";
    dBox.innerHTML = `
      <button class="secondary" onclick="editDriverMobile()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
      <button class="danger" onclick="cancelDriverRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
    `;
  } else {
    mainBtn.innerText = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ";
    dBox.innerHTML = `<button class="secondary" onclick="registerDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  }
  
  mainBtn.onclick = showForm;
  subBtn.innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á";
  subBtn.onclick = showHistory;
}

function formatD(d) { return (d && d.includes("T")) ? d.split("T")[0] : d; }
function formatT(t) { return (t && t.includes("T")) ? t.split("T")[1].substring(0, 5) : t; }

async function showHistory() {
  toggleLoading(true);
  document.getElementById("formBox").style.display = "none";
  const hBox = document.getElementById("historyBox");
  hBox.style.display = "block";

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "get_all_bookings", line_user_id: userId })
  }).then(r => r.json());

  let list = res.data || [];
  // ‡∏Å‡∏£‡∏≠‡∏á: ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á + ‡∏á‡∏≤‡∏ô Pending (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö)
  let filtered = list.filter(b => {
    const isMine = (b.booked_by === userId || b.driver_line_id === userId);
    const isPending = (b.status === "pending");
    return (role === "driver") ? (isMine || isPending) : isMine;
  });

  if (filtered.length === 0) {
    hBox.innerHTML = "<p style='text-align:center; color:#888;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</p>";
  } else {
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    hBox.innerHTML = "<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>" + filtered.reverse().map(b => {
      // Logic ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Driver + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Pending + ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏à‡∏≠‡∏á‡πÄ‡∏≠‡∏á
      const canAccept = (role === "driver" && b.status === "pending" && b.booked_by !== userId);
      // Logic ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å: ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      const canCancel = ((b.booked_by === userId || b.driver_line_id === userId) && b.status !== 'cancelled');

      return `
        <div class="card">
          <div class="label-text">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà & ‡πÄ‡∏ß‡∏•‡∏≤:</div>
          <div class="val-text"><b>${formatD(b.booking_date)} | ${formatT(b.booking_time)} ‡∏ô.</b></div>
          <div class="label-text">üìç ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</div>
          <div class="val-text">${b.pickup_location} ‚Üí ${b.dropoff_location}</div>
          <div class="label-text">üö¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</div>
          <div class="val-text" style="color:${b.status === 'pending' ? '#f39c12' : '#27ae60'}">
            <b>${b.status.toUpperCase()}</b> ${b.driver_name ? '(‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: '+b.driver_name+')' : ''}
          </div>
          
          ${canAccept ? `<button class="success" onclick="acceptJob('${b.booking_id}')">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
          ${canCancel ? `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>` : ""}
        </div>
      `;
    }).join("") + `<button class="secondary" onclick="closeHistory()">‡∏õ‡∏¥‡∏î</button>`;
  }
  toggleLoading(false);
}

async function acceptJob(id) {
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  toggleLoading(true);
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName })
  }).then(r => r.json());
  toggleLoading(false);
  if (res.success) { alert("‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); showHistory(); } else { alert(res.message); }
}

async function cancelDriverRole() {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ?")) return;
  toggleLoading(true);
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "cancel_driver", line_user_id: userId })
  }).then(r => r.json());
  if (res.success) { alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); location.reload(); }
  toggleLoading(false);
}

async function registerDriver() {
  const phone = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô:");
  if(!phone) return;
  toggleLoading(true);
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: phone })
  }).then(r => r.json());
  if (res.success) { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); location.reload(); }
  toggleLoading(false);
}

async function submitBooking() {
  const fields = ["booking_date", "booking_time", "vehicle_type", "passenger_count", "pickup_location", "dropoff_location", "contact_mobile"];
  for (let f of fields) { if (!document.getElementById(f).value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); }
  toggleLoading(true);
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action: role === "driver" ? "driver_create_booking" : "create_booking",
      line_user_id: userId, display_name: displayName,
      booking_date: document.getElementById("booking_date").value,
      booking_time: document.getElementById("booking_time").value,
      vehicle_type: document.getElementById("vehicle_type").value,
      passenger_count: document.getElementById("passenger_count").value,
      pickup_location: document.getElementById("pickup_location").value,
      dropoff_location: document.getElementById("dropoff_location").value,
      contact_mobile: document.getElementById("contact_mobile").value
    })
  }).then(r => r.json());
  toggleLoading(false);
  if (res.success) { alert("‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); closeForm(); showHistory(); }
}

function showForm() { document.getElementById("formBox").style.display = "block"; document.getElementById("historyBox").style.display = "none"; document.getElementById("contact_mobile").value = mobile; }
function closeForm() { document.getElementById("formBox").style.display = "none"; }
function closeHistory() { document.getElementById("historyBox").style.display = "none"; }

async function cancelBooking(id) { 
  if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")){ 
    toggleLoading(true); 
    const res = await fetch(ENDPOINT, { method:"POST", body:JSON.stringify({action:"cancel_booking", booking_id:id, line_user_id:userId}) }).then(r=>r.json()); 
    toggleLoading(false);
    if(res.success) showHistory(); 
  } 
}

async function editDriverMobile() { 
  const phone = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà:", mobile); 
  if(phone){ 
    toggleLoading(true); 
    const res = await fetch(ENDPOINT, { method:"POST", body:JSON.stringify({action:"edit_driver_mobile", line_user_id:userId, mobile_phone:phone}) }).then(r=>r.json()); 
    toggleLoading(false);
    if(res.success) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß"); mobile = phone; } 
  } 
}

init();
</script>
</body>
</html>
