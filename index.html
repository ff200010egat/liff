<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:sans-serif;background:#f5f5f5;padding:15px}
h1{font-size:26px;text-align:center}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:10px}
.big{font-size:20px;padding:18px;width:100%}
button{padding:12px;width:100%;margin-top:8px;font-size:16px}
.hidden{display:none}
</style>
</head>
<body>

<h1>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h1>

<div class="card">
  <b id="name"></b><br>
  <span id="role"></span>
</div>

<div class="card">
  <button class="big" onclick="showBooking()">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
  <button id="historyBtn" onclick="loadHistory()">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button id="driverBtn" onclick="toggleDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<div id="booking" class="card hidden">
  <input id="date" type="date"><br>
  <input id="time" type="time"><br>
  <input id="pickup" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö"><br>
  <input id="dropoff" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á"><br>
  <input id="mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"><br>
  <button onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<div id="list" class="card hidden"></div>

<script>
const GAS = "https://script.google.com/macros/s/AKfycbx3yWLg9H_fBHB7-lRIyWgo-OVXaJEwZZGFT0VDzR3VO10wl9kpWZuR53XPQT5T3m_RVA/exec";
let profile = {};

async function init() {
  await liff.init({ liffId: "2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();

  profile = await liff.getProfile();
  document.getElementById("name").innerText = profile.displayName;

  await post("auto_register",{line_user_id:profile.userId,display_name:profile.displayName});
}
init();

function post(action,data){
  return fetch(GAS,{
    method:"POST",
    body:JSON.stringify({...data,action})
  }).then(r=>r.json());
}

function showBooking(){
  document.getElementById("booking").classList.remove("hidden");
}

function submitBooking(){
  post("create_booking",{
    line_user_id:profile.userId,
    booking_date:date.value,
    booking_time:time.value,
    pickup_location:pickup.value,
    dropoff_location:dropoff.value,
    contact_mobile:mobile.value
  }).then(()=>alert("‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
}

function loadHistory(){
  post("get_my_bookings",{line_user_id:profile.userId})
  .then(r=>{
    list.innerHTML = r.data.map(b=>`üìÖ ${b[2]} ${b[3]} ‚Üí ${b[6]}`).join("<hr>");
    list.classList.remove("hidden");
  });
}

function toggleDriver(){
  const phone = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£");
  post("register_driver",{line_user_id:profile.userId,mobile_phone:phone})
  .then(()=>alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß"));
}
</script>
</body>
</html>
