<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: system-ui; padding:16px; background:#fafafa; color:#333; }
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:12px; border:1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
h2 { font-size:24px; margin-bottom:10px; color:#0a7cff; }
#username { font-size:18px; font-weight:bold; }
#role { font-size:16px; color:#666; margin-bottom:16px; }
button { width:100%; padding:14px; font-size:16px; border-radius:10px; border:none; margin-bottom:10px; cursor: pointer; font-weight:bold; }
.primary { background:#0a7cff; color:#fff; }
.secondary { background:#e0e0e0; color:#333; }
.danger { background:#e53935; color:#fff; }
.success { background:#2e7d32; color:#fff; }
input, select { width:100%; padding:12px; box-sizing: border-box; font-size:16px; margin-bottom:8px; border-radius:8px; border:1px solid #ccc; }
#formBox, #historyBox { display:none; }
.label { font-size:14px; color:#888; margin-top:4px; }
.val { font-size:16px; font-weight:500; margin-bottom:8px; }
</style>
</head>
<body>

<h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ ‡∏´‡∏Å-‡∏°‡∏ô.</h2>
<div id="username">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...</div>
<div id="role"></div>

<button id="mainBtn" class="primary"></button>
<button id="subBtn" class="secondary"></button>
<div id="driverBox"></div>

<div id="formBox" class="card">
  <h3 id="formTitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
  <input type="date" id="booking_date">
  <input type="time" id="booking_time">
  <select id="vehicle_type">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>
    <option value="‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á">‡∏£‡∏ñ‡πÄ‡∏Å‡πã‡∏á</option>
    <option value="‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞</option>
    <option value="‡∏£‡∏ñ‡∏ï‡∏π‡πâ">‡∏£‡∏ñ‡∏ï‡∏π‡πâ</option>
    <option value="‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
  </select>
  <input type="number" id="passenger_count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£">
  <input type="text" id="pickup_location" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
  <input type="text" id="dropoff_location" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
  <input type="text" id="contact_mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
  <button class="primary" onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button class="secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<div id="historyBox"></div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbyQovetwqhpnyjQWF-jqzKcJ49Tgd09BnIoAWVBEenp--UEs2nd2sTQrECvmzMKp7_Xpw/exec"; // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
let userId = "", role = "", mobile = "", displayName = "";

async function init() {
  await liff.init({ liffId: "2008934745-qU0fPztf" });
  if (!liff.isLoggedIn()) liff.login();
  const p = await liff.getProfile();
  userId = p.userId; displayName = p.displayName;
  document.getElementById("username").innerText = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, " + displayName;

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "auto_register", line_user_id: userId, display_name: displayName })
  }).then(r => r.json());

  role = res.role; mobile = res.mobile || "";
  render();
}

function render() {
  const mainBtn = document.getElementById("mainBtn");
  document.getElementById("role").innerText = role === "driver" ? "üîì ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ" : "üë§ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
  const dBox = document.getElementById("driverBox");
  dBox.innerHTML = "";

  if (role === "driver") {
    mainBtn.innerText = "‡∏•‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)";
    dBox.innerHTML = `
      <button class="secondary" onclick="editDriverMobile()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
      <button class="danger" onclick="cancelDriverRole()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
    `;
  } else {
    mainBtn.innerText = "‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö";
    dBox.innerHTML = `<button class="secondary" onclick="registerDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>`;
  }
  mainBtn.onclick = showForm;
  document.getElementById("subBtn").innerText = "‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô";
  document.getElementById("subBtn").onclick = showHistory;
}

/* --- Helpers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤ ISO --- */
function formatDisplayDate(dateStr) {
  if (!dateStr || dateStr === "null") return "-";
  return dateStr.split('T')[0];
}
function formatDisplayTime(timeStr) {
  if (!timeStr || timeStr === "null") return "-";
  if (timeStr.includes('T')) return timeStr.split('T')[1].substring(0, 5);
  return timeStr;
}

async function showHistory() {
  document.getElementById("formBox").style.display = "none";
  const hBox = document.getElementById("historyBox");
  hBox.style.display = "block";
  hBox.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>";

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "get_my_bookings", line_user_id: userId, role: role })
  }).then(r => r.json());

  if (!res.data || res.data.length === 0) {
    hBox.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p><button class='secondary' onclick='closeHistory()'>‡∏õ‡∏¥‡∏î</button>";
    return;
  }
  
  hBox.innerHTML = "<h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>" + res.data.map(b => renderBookingCard(b)).join("") + `<button class='secondary' onclick='closeHistory()'>‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>`;
}

function renderBookingCard(b) {
  const isPending = b.status === "pending";
  const canCancel = (b.booked_by === userId || b.driver_line_id === userId) && b.status !== "cancelled";
  const isDriverButNotOwner = role === "driver" && isPending && b.booked_by !== userId;

  return `
    <div class="card">
      <div class="label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</div>
      <div class="val">${formatDisplayDate(b.booking_date)} | ${formatDisplayTime(b.booking_time)} ‡∏ô.</div>
      <div class="label">üìç ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</div>
      <div class="val">${b.pickup_location} ‚ûî ${b.dropoff_location}</div>
      <div class="label">üí¨ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</div>
      <div class="val" style="color:${b.status === 'pending' ? '#f39c12' : '#27ae60'}">
        ${b.status.toUpperCase()} ${b.driver_name ? '(' + b.driver_name + ')' : ''}
      </div>
      ${isDriverButNotOwner ? `<button class="success" onclick="acceptJob('${b.booking_id}')">‚úÖ ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ (First Get)</button>` : ""}
      ${canCancel ? `<button class="danger" onclick="cancelBooking('${b.booking_id}')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>` : ""}
    </div>
  `;
}

async function acceptJob(id) {
  if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({ action: "accept_job", booking_id: id, line_user_id: userId, display_name: displayName })
  }).then(r => r.json());
  if (res.success) { alert("‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); showHistory(); }
  else alert(res.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ");
}

async function submitBooking() {
  const fields = ["booking_date", "booking_time", "vehicle_type", "passenger_count", "pickup_location", "dropoff_location", "contact_mobile"];
  for (let f of fields) { if (!document.getElementById(f).value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); }

  const res = await fetch(ENDPOINT, {
    method: "POST",
    body: JSON.stringify({
      action: role === "driver" ? "driver_create_booking" : "create_booking",
      line_user_id: userId, display_name: displayName,
      booking_date: document.getElementById("booking_date").value,
      booking_time: document.getElementById("booking_time").value,
      vehicle_type: document.getElementById("vehicle_type").value,
      passenger_count: document.getElementById("passenger_count").value,
      pickup_location: document.getElementById("pickup_location").value.trim(),
      dropoff_location: document.getElementById("dropoff_location").value.trim(),
      contact_mobile: document.getElementById("contact_mobile").value.trim()
    })
  }).then(r => r.json());

  if (res.success) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); closeForm(); showHistory(); }
  else alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
}

/* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ --- */
function showForm() { document.getElementById("formBox").style.display = "block"; document.getElementById("historyBox").style.display = "none"; document.getElementById("contact_mobile").value = mobile; }
function closeForm() { document.getElementById("formBox").style.display = "none"; }
function closeHistory() { document.getElementById("historyBox").style.display = "none"; }
async function registerDriver() {
  const phone = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ", mobile);
  if (!phone) return;
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "register_driver", line_user_id: userId, mobile_phone: phone.trim() }) }).then(r => r.json());
  if (res.success) { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); role = "driver"; mobile = phone.trim(); render(); }
}
async function cancelBooking(id) {
  if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_booking", booking_id: id, line_user_id: userId }) }).then(r => r.json());
  if (res.success) showHistory();
}
async function editDriverMobile() {
  const phone = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡∏°‡πà", mobile);
  if (!phone) return;
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "edit_driver_mobile", line_user_id: userId, mobile_phone: phone.trim() }) }).then(r => r.json());
  if (res.success) mobile = phone.trim();
}
async function cancelDriverRole() {
  if (!confirm("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö?")) return;
  const res = await fetch(ENDPOINT, { method: "POST", body: JSON.stringify({ action: "cancel_driver", line_user_id: userId }) }).then(r => r.json());
  if (res.success) { role = "user"; render(); }
}

init();
</script>
</body>
</html>
