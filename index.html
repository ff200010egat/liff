<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body{font-family:sans-serif;background:#f4f4f4;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:10px}
button,input{width:100%;padding:12px;margin-top:6px;font-size:16px}
.hidden{display:none}
</style>
</head>
<body>

<h2>üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h2>

<div class="card">
  <b id="name"></b><br>
  <span id="role"></span>
</div>

<div class="card">
  <button id="bookBtn" onclick="showBooking()">‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>
  <button id="historyBtn" onclick="loadMyBookings()">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
  <button id="driverBtn" onclick="registerAsDriver()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</button>
</div>

<div id="booking" class="card hidden">
  <input id="date" type="date">
  <input id="time" type="time">
  <input id="pickup" placeholder="‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö">
  <input id="dropoff" placeholder="‡∏à‡∏∏‡∏î‡∏™‡πà‡∏á">
  <input id="mobile" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠">
  <button onclick="submitBooking()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
</div>

<div id="list" class="card hidden"></div>

<script>
const GAS = "https://script.google.com/macros/s/AKfycbyf8dXphL_lkFgqm2RGuWFEsRDgRX50gSzG_fkqjA_Ze4rm6F_2nyMT2lTki_tn3308BQ/exec";
let profile = {};
let roleValue = 'user';

async function init(){
  await liff.init({liffId:"2008934745-qU0fPztf"});
  if(!liff.isLoggedIn()) liff.login();

  profile = await liff.getProfile();

  const r = await post('auto_register',{
    line_user_id: profile.userId,
    display_name: profile.displayName
  });

  name.innerText = r.data.display_name;
  roleValue = r.data.role;

  applyRoleUI();
}
init();

function applyRoleUI(){
  if(roleValue === 'driver'){
    role.innerText = 'üöó ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ';
    driverBtn.classList.add('hidden');
    historyBtn.innerText = '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö';
  }else{
    role.innerText = 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
    driverBtn.classList.remove('hidden');
    historyBtn.innerText = '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
  }
}

function post(action,data){
  return fetch(GAS,{
    method:'POST',
    body:JSON.stringify({...data,action})
  }).then(r=>r.json());
}

function showBooking(){
  booking.classList.remove('hidden');
}

async function submitBooking(){
  const r = await post('create_booking',{
    line_user_id: profile.userId,
    booking_date: date.value,
    booking_time: time.value,
    pickup_location: pickup.value,
    dropoff_location: dropoff.value,
    contact_mobile: mobile.value
  });

  if(r.success){
    alert('‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    booking.classList.add('hidden');
  }else{
    alert('‚ùå '+r.data);
  }
}

async function loadMyBookings(){
  list.classList.remove('hidden');
  list.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

  if(roleValue === 'driver'){
    const r = await post('get_driver_jobs',{});
    list.innerHTML = r.data.map(b =>
      `üìÖ ${b[2]} ${b[3]}<br>${b[6]} ‚Üí ${b[7]}`
    ).join('<hr>');
  }else{
    const r = await post('get_my_bookings',{line_user_id:profile.userId});
    list.innerHTML = r.data.map(b =>
      `üìÖ ${b[2]} ${b[3]}<br>${b[6]} ‚Üí ${b[7]}`
    ).join('<hr>');
  }
}

async function registerAsDriver(){
  const phone = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
  if(!phone) return;

  const r = await post('register_driver',{
    line_user_id: profile.userId,
    mobile_phone: phone
  });

  if(r.success){
    roleValue = 'driver';
    applyRoleUI();
    alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡πâ‡∏ß');
  }
}
</script>

</body>
</html>
